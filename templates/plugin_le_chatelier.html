{% extends "base.html" %}

{% block title %}–ü—Ä–∏–Ω—Ü–∏–ø –õ–µ –®–∞—Ç–µ–ª—å–µ - {{ config.site_title }}{% endblock %}

{% block header %}
<header class="header">
    <div class="header-content">
        <div class="logo-section">
            <a href="/" class="back-link" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-arrow-left"></i>
                <img src="{{ config.site_logo_dark if config and config.site_logo_dark else '/static/images/logo-dark.png' }}" alt="–õ–æ–≥–æ—Ç–∏–ø {{ config.site_title }}" class="header-logo">
            </a>
            <h1 class="site-title">–ü—Ä–∏–Ω—Ü–∏–ø –õ–µ –®–∞—Ç–µ–ª—å–µ</h1>
        </div>
        <nav class="header-nav">
            <button class="theme-toggle" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                <i class="fas fa-moon" aria-hidden="true"></i>
            </button>
            <a href="/" class="admin-link" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é">
                <i class="fas fa-home" aria-hidden="true"></i> <span>–ì–ª–∞–≤–Ω–∞—è</span>
            </a>
        </nav>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="plugin-container">
    <main class="main-content">
        <div class="principle-container">

            <div class="info-section">
                <h2>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–º–µ—â–µ–Ω–∏—è —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—è</h2>
                <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Ä–µ–∞–∫—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:</p>
                <code>1-2=3+4+1</code>
            </div>

            <form id="equilibriumForm" class="form">
                <div class="form-group">
                    <label>–£—Ä–∞–≤–Ω–µ–Ω–∏–µ:</label>
                    <input id="equation" class="form-control" placeholder="1-2=3+4+1" required>
                </div>
                <button class="btn-primary">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            </form>

            <div id="result" class="result-section hidden">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç</h3>

                <div class="equation-card">
                    <div class="equation-number">1</div>
                    <div id="equationDisplay" class="equation-display"></div>
                </div>

                <!-- ‚ñ∫ –ù–û–í–ê–Ø –§–û–†–ú–£–õ–ê (–¥—Ä–æ–±—å —Å –±—É–∫–≤–∞–º–∏) -->
                <div class="formula-card">
                    <div class="formula-title">–§–æ—Ä–º—É–ª–∞ —Å –±—É–∫–≤–∞–º–∏:</div>
                    <div class="fraction">
                        <div id="letterFractionNum" class="fraction-numerator"></div>
                        <div class="fraction-line"></div>
                        <div id="letterFractionDen" class="fraction-denominator"></div>
                    </div>
                </div>

                <div class="result-header">
                    <div class="result-item">
                        <div class="label">Œîn:</div>
                        <div id="deltaValue" class="value"></div>
                    </div>
                    <div class="result-item">
                        <div class="label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</div>
                        <div id="direction" class="value"></div>
                    </div>
                </div>

                <div class="explanation-box">
                    <div class="explanation-header"><i class="fas fa-lightbulb"></i> –û–±—ä—è—Å–Ω–µ–Ω–∏–µ</div>
                    <p id="explanation"></p>
                </div>
            </div>

            <div id="error" class="error-section hidden">
                <h3><i class="fas fa-exclamation-circle"></i> –û—à–∏–±–∫–∞</h3>
                <p id="errorMessage"></p>
            </div>

        </div>
    </main>
</div>


<script>
/* =======================================================
                –¢—ë–º–µ –ø—Ä–∏–≤–µ—Ç!!
======================================================= */
document.addEventListener("DOMContentLoaded", () => {
    initTheme();
    document.getElementById("equilibriumForm")
        .addEventListener("submit", calculateEquilibrium);
});

function initTheme() {
    const btn = document.getElementById("themeToggle");
    const saved = localStorage.getItem("theme") || "light";
    document.documentElement.setAttribute("data-theme", saved);

    btn.addEventListener("click", () => {
        const current = document.documentElement.getAttribute("data-theme");
        const next = current === "light" ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
    });
}

/* =======================================================
        –ì–ï–ù–ï–†–ê–¶–ò–Ø –§–û–†–ú–£–õ–´ –ü–û üòÉ‚û∞ –õ–û–ì–ò–ö–ï
======================================================= */

function generateLetterFormula(eq) {
    const parts = eq.split("=");
    if (parts.length !== 2) return { numerator: "‚Äî", denominator: "‚Äî" };

    const left = parts[0].match(/[+-]?\d+/g)?.map(Number) || [];

    const rightRaw = parts[1].match(/[+-]?\d+/g)?.map(Number) || [];
    const right = rightRaw.slice(0, -1); // —É–±–∏—Ä–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–π

    const letters = "abcdefghijklmnopqrstuvwxyz";

    const SUP = {
        "-": "‚Åª", "0": "‚Å∞", "1": "¬π", "2": "¬≤", "3": "¬≥",
        "4": "‚Å¥", "5": "‚Åµ", "6": "‚Å∂", "7": "‚Å∑",
        "8": "‚Å∏", "9": "‚Åπ"
    };

    const toSup = n => n.toString().split("").map(c => SUP[c]).join("");

    function build(arr, offset) {
        return arr.map((coef, i) => {
            const letter = letters[i + offset];
            return `C${letter}${toSup(coef)}`;
        }).join(" * ");
    }

    return {
        numerator: build(left, 0),                  // –ª–µ–≤–∞—è —á–∞—Å—Ç—å ‚Üí Ca¬π, Cb‚Åª¬≤
        denominator: build(right, left.length)      // –ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å ‚Üí Cc¬≥, Cd‚Å¥
    };
}

/* =======================================================
                API –†–ê–°–ß–Å–¢–ê
======================================================= */

async function calculateEquilibrium(e) {
    e.preventDefault();

    const input = document.getElementById("equation").value.trim();
    if (!input) return;

    try {
        const r = await fetch(`/api/plugin/le_chatelier?equation=${encodeURIComponent(input)}`);
        const data = await r.json();
        if (data.error) return showError(data.message);
        showResult(data, input);
    } catch (err) {
        showError(err.message);
    }
}

/* =======================================================
                –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï
======================================================= */

function showResult(result, eq) {
    document.getElementById("error").classList.add("hidden");
    document.getElementById("result").classList.remove("hidden");

    document.getElementById("equationDisplay").innerHTML = `<code>${eq}</code>`;
    document.getElementById("deltaValue").innerText = result.delta;

    const f = generateLetterFormula(eq);
    document.getElementById("letterFractionNum").innerHTML = f.numerator;
    document.getElementById("letterFractionDen").innerHTML = f.denominator;

    document.getElementById("direction").innerText =
        result.direction === "right" ? "‚Üí –í–ø—Ä–∞–≤–æ" :
        result.direction === "left" ? "‚Üê –í–ª–µ–≤–æ" :
        "‚Üî –ë–µ–∑ —Å–º–µ—â–µ–Ω–∏—è";

    document.getElementById("explanation").innerText = result.explanation;
}

function showError(msg) {
    document.getElementById("result").classList.add("hidden");
    document.getElementById("error").classList.remove("hidden");
    document.getElementById("errorMessage").innerText = msg;
}
</script>

{% endblock %}
