{% extends "base.html" %}

{% block title %}{{ config.site_title }} - Главная{% endblock %}

{% block header %}
<!-- Header -->
<header class="header">
    <div class="header-content">
        <div class="logo-section">
            <img id="headerLogo" src="{{ config.site_logo_dark if config and config.site_logo_dark else '/static/images/logo-dark.png' }}" alt="Логотип {{ config.site_title }}" class="header-logo">
            <h1 class="site-title">{{ config.site_title }}</h1>
        </div>
        <nav class="header-nav">
            <button class="theme-toggle" id="themeToggle" title="Переключить тему" aria-label="Переключить тему">
                <i class="fas fa-moon" aria-hidden="true"></i>
            </button>
            <a href="/admin" class="admin-link" aria-label="Панель администратора">
                <i class="fas fa-lock" aria-hidden="true"></i> <span>Админ</span>
            </a>
        </nav>
    </div>
</header>
{% endblock %}

    {% block content %}
<div class="app-container" id="mainApp">
    <!-- Main Content -->
    <main class="main-content">
        <div class="welcome-section">
            <div class="welcome-text">
                <h2>Добро пожаловать на {{ config.site_title }}</h2>
                <p>{{ config.site_description }}</p>
            </div>
        </div>

        <!-- Tiles Grid -->
        <div class="tiles-container" id="tilesContainer">
            <!-- Tiles will be loaded dynamically -->
        </div>

        <!-- Posts Section -->
        <section class="posts-section">
            <div class="posts-section-header">
                <h2><i class="fas fa-newspaper" aria-hidden="true"></i> Последние статьи</h2>
            </div>
            <div class="posts-grid" id="postsGrid">
                <!-- Posts will be loaded dynamically -->
            </div>
            <div id="noPostsMessage" class="no-posts-message hidden">
                <i class="fas fa-file-alt" aria-hidden="true"></i>
                <p>Статей пока нет. Загляните позже!</p>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 - 2026 {{ config.site_title }}. By ИСП-225.</p>
    </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    initTheme();
    loadTiles();
    loadPosts();
});

function initTheme() {
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'light';

    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);

    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';

        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    });
}

function updateThemeIcon(theme) {
    const icon = document.getElementById('themeToggle').querySelector('i');
    icon.className = theme === 'light' ? 'fas fa-sun' : 'fas fa-moon';
}

async function loadTiles() {
    try {
        const response = await axios.get('/api/config');
        const pluginsResponse = await axios.get('/api/plugins');
        const container = document.getElementById('tilesContainer');
        container.innerHTML = '';

        // Get saved order from server config
        const savedOrder = response.data.tiles_order || [];
        let plugins = Object.entries(pluginsResponse.data);
        
        // Filter enabled plugins and sort by saved order
        const enabledPlugins = plugins.filter(([name, plugin]) => plugin.enabled);
        
        if (savedOrder.length > 0) {
            enabledPlugins.sort((a, b) => {
                const aIndex = savedOrder.indexOf(a[0]);
                const bIndex = savedOrder.indexOf(b[0]);
                if (aIndex === -1) return 1;
                if (bIndex === -1) return -1;
                return aIndex - bIndex;
            });
        }

        enabledPlugins.forEach(([name, plugin]) => {
            const tile = createTile(name, plugin);
            container.appendChild(tile);
        });
    } catch (error) {
        console.error('Error loading tiles:', error);
    }
}

function createTile(name, plugin) {
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.innerHTML = `
        <div class="tile-header">
            <i class="fas fa-${plugin.icon}" aria-hidden="true"></i>
            <h3>${plugin.name}</h3>
        </div>
        <p class="tile-description">${plugin.description}</p>
        <button class="tile-button" onclick="openPlugin('${name}')" aria-label="Открыть ${plugin.name}">
            Открыть <i class="fas fa-arrow-right" aria-hidden="true"></i>
        </button>
    `;
    return tile;
}

function openPlugin(name) {
    window.location.href = `/plugin/${name}`;
}

async function loadPosts() {
    try {
        const response = await axios.get('/api/admin/posts');
        const postsGrid = document.getElementById('postsGrid');
        const noPostsMessage = document.getElementById('noPostsMessage');

        postsGrid.innerHTML = '';

        if (response.data.length === 0) {
            noPostsMessage.classList.remove('hidden');
            return;
        }

        noPostsMessage.classList.add('hidden');

        // Show latest 6 posts
        const latestPosts = response.data.slice(-6).reverse();

        latestPosts.forEach(post => {
            const postCard = createPostCard(post);
            postsGrid.appendChild(postCard);
        });
    } catch (error) {
        console.error('Error loading posts:', error);
    }
}

function createPostCard(post) {
    const card = document.createElement('article');
    card.className = 'post-card';

    const date = new Date(post.updated_at);
    const formattedDate = date.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });

    // Truncate content for preview
    const preview = post.content.length > 150
        ? post.content.substring(0, 150) + '...'
        : post.content;

    card.innerHTML = `
        <div class="post-card-content">
            <h3 class="post-card-title">${escapeHtml(post.title)}</h3>
            <p class="post-card-preview">${escapeHtml(preview)}</p>
            <div class="post-card-footer">
                <span class="post-card-date"><i class="fas fa-calendar" aria-hidden="true"></i> ${formattedDate}</span>
                <button class="post-card-btn" onclick="openPost(${post.id})" aria-label="Читать ${escapeHtml(post.title)}">
                    Читать <i class="fas fa-arrow-right" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    `;
    return card;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function openPost(postId) {
    window.location.href = `/post/${postId}`;
}
</script>
{% endblock %}
