{% extends "base.html" %}

{% block title %}Панель администратора - {{ config.site_title }}{% endblock %}

{% block header %}
<header class="header">
    <div class="header-content">
        <div class="logo-section">
            <img id="headerLogo" src="{{ config.site_logo_dark if config and config.site_logo_dark else '/static/images/logo-dark.png' }}" alt="Логотип {{ config.site_title }}" class="header-logo">
            <h1 class="site-title">{{ config.site_title }}</h1>
        </div>
        <nav class="header-nav">
            <button class="theme-toggle" id="themeToggle" title="Переключить тему" aria-label="Переключить тему">
                <i class="fas fa-moon" aria-hidden="true"></i>
            </button>
            <a href="/" class="admin-link" aria-label="На главную">
                <i class="fas fa-home" aria-hidden="true"></i> <span>Главная</span>
            </a>
            <a href="/logout" class="admin-link" aria-label="Выход">
                <i class="fas fa-sign-out-alt" aria-hidden="true"></i> <span>Выход</span>
            </a>
        </nav>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-sidebar">
        <div class="sidebar-header">
            <!-- Fixed logo display -->
            <img id="adminLogo" src="{{ config.site_logo_dark if config and config.site_logo_dark else '/static/images/logo-dark.png' }}" alt="Логотип" class="admin-logo">
            <h2><i class="fas fa-cog"></i> Админ-панель</h2>
            <span class="version-badge">v1.0</span>
        </div>
        <nav class="admin-nav">
            <button class="nav-item active" onclick="switchTab('dashboard')">
                <i class="fas fa-chart-line"></i> Статистика
            </button>
            <button class="nav-item" onclick="switchTab('tiles')">
                <i class="fas fa-th"></i> Плитки
            </button>
            <button class="nav-item" onclick="switchTab('posts')">
                <i class="fas fa-file-alt"></i> Статьи
            </button>
            <button class="nav-item" onclick="switchTab('plugins')">
                <i class="fas fa-plug"></i> Плагины
            </button>
            <button class="nav-item" onclick="switchTab('settings')">
                <i class="fas fa-sliders-h"></i> Настройки
            </button>
            <!-- Added security tab -->
            <button class="nav-item" onclick="switchTab('security')">
                <i class="fas fa-shield-alt"></i> Безопасность
            </button>
        </nav>
        <div class="sidebar-footer">
            <!-- Added logout button -->
            <a href="/logout" class="logout-link">
                <i class="fas fa-sign-out-alt"></i> Выйти
            </a>
            <a href="/" class="back-link">
                <i class="fas fa-arrow-left"></i> На главную
            </a>
        </div>
    </div>

    <div class="admin-content">
        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <div class="tab-header">
                <h2>Статистика</h2>
            </div>
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-th"></i></div>
                    <div class="stat-info">
                        <h4>Активные плитки</h4>
                        <span id="activeTilesCount">2</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                    <div class="stat-info">
                        <h4>Всего статей</h4>
                        <span id="totalPostsCount">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-plug"></i></div>
                    <div class="stat-info">
                        <h4>Плагины</h4>
                        <span id="pluginsCount">2</span>
                    </div>
                </div>
            </div>

            <!-- Added visit statistics table -->
            <div class="tab-header" style="margin-top: 2rem;">
                <h2><i class="fas fa-eye"></i> Статистика посещений</h2>
                <button class="btn-secondary btn-sm" onclick="loadVisitStats()" style="margin-left: 1rem;">
                    <i class="fas fa-sync-alt"></i> Обновить
                </button>
            </div>
            <div class="stats-table-container">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Период</th>
                            <th>Всего посещений</th>
                            <th>Уникальных (сессий)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><i class="fas fa-clock"></i> За час</td>
                            <td id="hourVisits">0 <span class="prev-stat">(пред: 0)</span></td>
                            <td id="hourUnique">0 <span class="prev-stat">(пред: 0)</span></td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-calendar-day"></i> За день</td>
                            <td id="dayVisits">0 <span class="prev-stat">(пред: 0)</span></td>
                            <td id="dayUnique">0 <span class="prev-stat">(пред: 0)</span></td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-calendar-alt"></i> За месяц</td>
                            <td id="monthVisits">0 <span class="prev-stat">(пред: 0)</span></td>
                            <td id="monthUnique">0 <span class="prev-stat">(пред: 0)</span></td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-calendar"></i> За год</td>
                            <td id="yearVisits">0 <span class="prev-stat">(пред: 0)</span></td>
                            <td id="yearUnique">0 <span class="prev-stat">(пред: 0)</span></td>
                        </tr>
                        <tr class="total-row">
                            <td><i class="fas fa-globe"></i> <strong>Всего</strong></td>
                            <td id="totalVisits"><strong>0</strong></td>
                            <td id="totalUnique"><strong>0</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tiles Tab -->
        <div id="tilesTab" class="tab-content">
            <div class="tab-header">
                <h2>Управление плитками</h2>
                <p class="tab-description">Выберите, какие плагины отображать на главной странице</p>
            </div>
            <div id="tilesList" class="tiles-list"></div>
        </div>

        <!-- Posts Tab -->
        <div id="postsTab" class="tab-content">
            <div class="tab-header">
                <h2>Управление статьями</h2>
                <button class="btn-primary btn-lg" onclick="openPostEditor()">
                    <i class="fas fa-plus"></i> Создать новую статью
                </button>
            </div>
            <div id="postsList" class="posts-list"></div>
        </div>

        <!-- Plugins Tab -->
        <div id="pluginsTab" class="tab-content">
            <div class="tab-header">
                <h2>Управление плагинами</h2>
                <p class="tab-description">Просмотр и управление установленными плагинами</p>
            </div>
            <div id="pluginsList" class="plugins-list"></div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <div class="tab-header">
                <h2>Параметры сайта</h2>
            </div>
            <form id="settingsForm" class="settings-form">
                <div class="form-group">
                    <label for="siteTitle">Название сайта</label>
                    <input type="text" id="siteTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="siteDescription">Описание сайта</label>
                    <textarea id="siteDescription" class="form-control" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="siteLogoLight">URL логотипа (светлый, для тёмной темы)</label>
                    <input type="text" id="siteLogoLight" class="form-control" placeholder="/static/images/logo-light.png">
                </div>
                <div class="form-group">
                    <label for="siteLogoDark">URL логотипа (тёмный, для светлой темы)</label>
                    <input type="text" id="siteLogoDark" class="form-control" placeholder="/static/images/logo-dark.png">
                </div>
                <div class="form-group">
                    <label for="theme">Тема по умолчанию</label>
                    <select id="theme" class="form-control">
                        <option value="light">Светлая</option>
                        <option value="dark">Тёмная</option>
                        <option value="auto">Авто (система)</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i> Сохранить
                </button>
            </form>
        </div>

        <!-- Added Security Tab for password change -->
        <div id="securityTab" class="tab-content">
            <div class="tab-header">
                <h2>Безопасность</h2>
                <p class="tab-description">Изменение пароля администратора</p>
            </div>
            <form id="passwordForm" class="settings-form">
                <div class="form-group">
                    <label for="oldPassword">Текущий пароль</label>
                    <input type="password" id="oldPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">Новый пароль</label>
                    <input type="password" id="newPassword" class="form-control" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Подтвердите новый пароль</label>
                    <input type="password" id="confirmPassword" class="form-control" required minlength="6">
                </div>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-key"></i> Изменить пароль
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Post Editor Modal -->
<div id="postEditorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Создать новую статью</h2>
            <button class="close-btn" onclick="closePostEditor()">&times;</button>
        </div>
        <form id="postForm" class="form">
            <div class="form-group">
                <label for="postTitle">Название статьи</label>
                <input type="text" id="postTitle" class="form-control" placeholder="Введите название" required>
            </div>
            <div class="form-group">
                <label for="postContent">Содержание статьи</label>
                <textarea id="postContent" class="form-control" rows="12" placeholder="Введите содержание" required></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="closePostEditor()">Отмена</button>
                <button type="submit" class="btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Added styles for statistics table */
.stats-table-container {
    background: var(--card-bg, #fff);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow-x: auto;
}

.stats-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
}

.stats-table th,
.stats-table td {
    padding: 1rem 1.25rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #e5e7eb);
}

.stats-table th {
    background: var(--table-header-bg, #f9fafb);
    font-weight: 600;
    color: var(--text-secondary, #6b7280);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
}

.stats-table td {
    color: var(--text-primary, #1f2937);
}

.stats-table td i {
    margin-right: 0.5rem;
    color: var(--primary-color, #3b82f6);
    width: 1.25rem;
}

.stats-table tbody tr:hover {
    background: var(--hover-bg, #f3f4f6);
}

.stats-table .total-row {
    background: var(--primary-light, #eff6ff);
    border-top: 2px solid var(--primary-color, #3b82f6);
}

.stats-table .total-row td {
    font-weight: 600;
}

.prev-stat {
    color: var(--text-muted, #9ca3af);
    font-size: 0.85em;
    margin-left: 0.5rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}

.tab-header {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
}

/* Dark theme support */
[data-theme="dark"] .stats-table-container {
    background: var(--card-bg-dark, #1f2937);
}

[data-theme="dark"] .stats-table th {
    background: var(--table-header-bg-dark, #374151);
    color: var(--text-secondary-dark, #9ca3af);
}

[data-theme="dark"] .stats-table td {
    color: var(--text-primary-dark, #f3f4f6);
    border-color: var(--border-color-dark, #374151);
}

[data-theme="dark"] .stats-table tbody tr:hover {
    background: var(--hover-bg-dark, #374151);
}

[data-theme="dark"] .stats-table .total-row {
    background: rgba(59, 130, 246, 0.15);
}

[data-theme="dark"] .prev-stat {
    color: var(--text-muted-dark, #6b7280);
}
</style>

<script>
let currentPostId = null;

document.addEventListener('DOMContentLoaded', function() {
    initAdmin();
    setupEventListeners();
    initTheme();
});

function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
}

function setupEventListeners() {
    document.getElementById('settingsForm').addEventListener('submit', handleSettingsSave);
    document.getElementById('postForm').addEventListener('submit', handlePostSave);
    document.getElementById('passwordForm').addEventListener('submit', handlePasswordChange);
}

function initAdmin() {
    loadDashboard();
    loadVisitStats(); // Load visit statistics
    loadTiles();
    loadPosts();
    loadPlugins();
    loadSettings();
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.classList.remove('active');
    });

    document.getElementById(tabName + 'Tab').classList.add('active');
    event.target.closest('.nav-item').classList.add('active');

    if (tabName === 'dashboard') {
        loadVisitStats();
    }
}

async function loadDashboard() {
    try {
        const pluginsRes = await axios.get('/api/plugins');
        const postsRes = await axios.get('/api/admin/posts');

        const enabledPlugins = Object.values(pluginsRes.data).filter(p => p.enabled).length;
        document.getElementById('activeTilesCount').textContent = enabledPlugins;
        document.getElementById('totalPostsCount').textContent = postsRes.data.length;
        document.getElementById('pluginsCount').textContent = Object.keys(pluginsRes.data).length;
    } catch (error) {
        console.error('Error loading dashboard:', error);
    }
}

async function loadVisitStats() {
    try {
        const response = await axios.get('/api/admin/statistics');
        const stats = response.data;

        // Helper function to format stat with previous value
        const formatStat = (current, previous) => {
            return `${current} <span class="prev-stat">(пред: ${previous})</span>`;
        };

        // Update hour stats
        document.getElementById('hourVisits').innerHTML = formatStat(
            stats.hour.current.visits,
            stats.hour.previous.visits
        );
        document.getElementById('hourUnique').innerHTML = formatStat(
            stats.hour.current.unique,
            stats.hour.previous.unique
        );

        // Update day stats
        document.getElementById('dayVisits').innerHTML = formatStat(
            stats.day.current.visits,
            stats.day.previous.visits
        );
        document.getElementById('dayUnique').innerHTML = formatStat(
            stats.day.current.unique,
            stats.day.previous.unique
        );

        // Update month stats
        document.getElementById('monthVisits').innerHTML = formatStat(
            stats.month.current.visits,
            stats.month.previous.visits
        );
        document.getElementById('monthUnique').innerHTML = formatStat(
            stats.month.current.unique,
            stats.month.previous.unique
        );

        // Update year stats
        document.getElementById('yearVisits').innerHTML = formatStat(
            stats.year.current.visits,
            stats.year.previous.visits
        );
        document.getElementById('yearUnique').innerHTML = formatStat(
            stats.year.current.unique,
            stats.year.previous.unique
        );

        // Update total stats
        document.getElementById('totalVisits').innerHTML = `<strong>${stats.total.visits}</strong>`;
        document.getElementById('totalUnique').innerHTML = `<strong>${stats.total.unique}</strong>`;

    } catch (error) {
        console.error('Error loading visit statistics:', error);
    }
}

async function loadTiles() {
    try {
        const response = await axios.get('/api/plugins');
        const container = document.getElementById('tilesList');
        container.innerHTML = '';
        
        for (const [name, plugin] of Object.entries(response.data)) {
            const item = document.createElement('div');
            item.className = 'tile-item';
            item.innerHTML = `
                <div class="tile-item-header">
                    <div class="tile-info">
                        <i class="fas fa-${plugin.icon}"></i>
                        <div>
                            <h3>${plugin.name}</h3>
                            <p>${plugin.description}</p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" ${plugin.enabled ? 'checked' : ''} 
                               onchange="toggleTile('${name}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            `;
            container.appendChild(item);
        }
    } catch (error) {
        console.error('Error loading tiles:', error);
    }
}

async function loadPosts() {
    try {
        const response = await axios.get('/api/admin/posts');
        const container = document.getElementById('postsList');
        container.innerHTML = '';
        
        if (response.data.length === 0) {
            container.innerHTML = '<p class="empty-state">Нет статей. Создайте первую!</p>';
            return;
        }
        
        response.data.forEach(post => {
            const item = document.createElement('div');
            item.className = 'post-item';
            const date = new Date(post.updated_at);
            item.innerHTML = `
                <div class="post-header">
                    <div class="post-info">
                        <h3>${post.title}</h3>
                        <p class="post-date">Обновлено: ${date.toLocaleDateString('ru-RU')} в ${date.toLocaleTimeString('ru-RU')}</p>
                    </div>
                    <div class="post-actions">
                        <button class="btn-small btn-edit" onclick="editPost(${post.id})" title="Редактировать">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-small btn-danger" onclick="deletePost(${post.id})" title="Удалить">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    } catch (error) {
        console.error('Error loading posts:', error);
    }
}

async function loadPlugins() {
    try {
        const response = await axios.get('/api/plugins');
        const container = document.getElementById('pluginsList');
        container.innerHTML = '';
        
        for (const [name, plugin] of Object.entries(response.data)) {
            const item = document.createElement('div');
            item.className = 'plugin-item';
            item.innerHTML = `
                <div class="plugin-header">
                    <i class="fas fa-${plugin.icon} plugin-icon"></i>
                    <div class="plugin-info">
                        <h3>${plugin.name}</h3>
                        <p>${plugin.description}</p>
                    </div>
                </div>
                <div class="plugin-meta">
                    <span class="version">v${plugin.version}</span>
                    <span class="status ${plugin.enabled ? 'active' : 'inactive'}">
                        ${plugin.enabled ? 'Активен' : 'Неактивен'}
                    </span>
                </div>
            `;
            container.appendChild(item);
        }
    } catch (error) {
        console.error('Error loading plugins:', error);
    }
}

async function loadSettings() {
    try {
        const response = await axios.get('/api/config');
        document.getElementById('siteTitle').value = response.data.site_title || '';
        document.getElementById('siteDescription').value = response.data.site_description || '';
        document.getElementById('siteLogoLight').value = response.data.site_logo_light || '/static/images/logo-light.png';
        document.getElementById('siteLogoDark').value = response.data.site_logo_dark || '/static/images/logo-dark.png';
        document.getElementById('theme').value = response.data.theme || 'light';
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

function openPostEditor() {
    currentPostId = null;
    document.getElementById('modalTitle').textContent = 'Создать новую статью';
    document.getElementById('postForm').reset();
    document.getElementById('postEditorModal').style.display = 'flex';
}

function closePostEditor() {
    document.getElementById('postEditorModal').style.display = 'none';
}

async function editPost(postId) {
    try {
        const posts = await axios.get('/api/admin/posts');
        const post = posts.data.find(p => p.id === postId);
        
        if (post) {
            currentPostId = postId;
            document.getElementById('modalTitle').textContent = 'Редактировать статью';
            document.getElementById('postTitle').value = post.title;
            document.getElementById('postContent').value = post.content;
            document.getElementById('postEditorModal').style.display = 'flex';
        }
    } catch (error) {
        alert('Ошибка при загрузке статьи');
    }
}

async function deletePost(postId) {
    if (confirm('Вы уверены, что хотите удалить эту статью?')) {
        try {
            await axios.delete(`/api/admin/posts/${postId}`);
            loadPosts();
            loadDashboard();
        } catch (error) {
            alert('Ошибка при удалении статьи');
        }
    }
}

async function handlePostSave(e) {
    e.preventDefault();
    
    const data = {
        title: document.getElementById('postTitle').value,
        content: document.getElementById('postContent').value
    };
    
    try {
        if (currentPostId) {
            await axios.put(`/api/admin/posts/${currentPostId}`, data);
        } else {
            await axios.post('/api/admin/posts', data);
        }
        closePostEditor();
        loadPosts();
        loadDashboard();
    } catch (error) {
        alert('Ошибка при сохранении статьи: ' + error.message);
    }
}

async function handleSettingsSave(e) {
    e.preventDefault();
    
    const data = {
        site_title: document.getElementById('siteTitle').value,
        site_description: document.getElementById('siteDescription').value,
        site_logo_light: document.getElementById('siteLogoLight').value,
        site_logo_dark: document.getElementById('siteLogoDark').value,
        theme: document.getElementById('theme').value
    };
    
    try {
        await axios.post('/api/config', data);
        alert('Параметры сохранены!');
    } catch (error) {
        alert('Ошибка при сохранении параметров');
    }
}

async function handlePasswordChange(e) {
    e.preventDefault();
    
    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        alert('Новый пароль и подтверждение не совпадают!');
        return;
    }
    
    try {
        await axios.post('/api/admin/change-password', {
            old_password: oldPassword,
            new_password: newPassword
        });
        alert('Пароль успешно изменён!');
        document.getElementById('passwordForm').reset();
    } catch (error) {
        alert('Ошибка: ' + (error.response?.data?.error || 'Неверный текущий пароль'));
    }
}

async function toggleTile(name, enabled) {
    try {
        await axios.post(`/api/plugins/${name}/toggle`);
        loadTiles();
        loadDashboard();
    } catch (error) {
        alert('Ошибка при обновлении плагина');
    }
}

window.onclick = function(event) {
    const modal = document.getElementById('postEditorModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}
</script>
{% endblock %}
