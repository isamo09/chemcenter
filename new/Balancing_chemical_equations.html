<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Балансировщик уравнений - Химические плагины</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f5f7fa;
            --dark-bg: #1a1a2e;
            --card-bg: #ffffff;
            --card-bg-dark: #2d3047;
            --text-color: #333333;
            --text-color-dark: #f0f0f0;
            --border-color: #dddddd;
            --border-color-dark: #444444;
            --muted-color: #777777;
            --muted-color-dark: #aaaaaa;
            --code-bg: #f8f9fa;
            --code-bg-dark: #2a2d3e;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --input-bg: #ffffff;
            --input-bg-dark: #2d3047;
            --table-header-bg: #f8f9fa;
            --table-header-bg-dark: #2a2d3e;
            --table-hover-bg: #f8f9fa;
            --table-hover-bg-dark: #3a3d4e;
        }

        [data-theme="dark"] {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-bg: #1a1a2e;
            --dark-bg: #0d0d15;
            --card-bg: #2d3047;
            --card-bg-dark: #252736;
            --text-color: #f0f0f0;
            --text-color-dark: #e0e0e0;
            --border-color: #444444;
            --border-color-dark: #555555;
            --muted-color: #aaaaaa;
            --muted-color-dark: #cccccc;
            --code-bg: #2a2d3e;
            --code-bg-dark: #1a1d2e;
            --input-bg: #2d3047;
            --input-bg-dark: #252736;
            --table-header-bg: #2a2d3e;
            --table-header-bg-dark: #1a1d2e;
            --table-hover-bg: #3a3d4e;
            --table-hover-bg-dark: #4a4d5e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .plugin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .plugin-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .plugin-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .plugin-title-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            height: 50px;
            width: auto;
            font-size: 32px;
        }

        .plugin-header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(15deg);
        }

        .principle-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .info-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid var(--accent-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .info-section h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 24px;
        }

        .info-section p {
            color: var(--text-color);
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .info-section code {
            background: var(--code-bg);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: var(--accent-color);
            font-weight: bold;
        }

        .form {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 16px;
        }

        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .equation-input {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }

        .form-group small {
            display: block;
            margin-top: 8px;
            color: var(--muted-color);
            font-size: 14px;
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .examples-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .example-tag {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-color);
        }

        .example-tag:hover {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: white;
            transform: translateY(-2px);
        }

        .example-tag.active {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
            justify-content: center;
        }

        .btn-primary:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
            justify-content: center;
        }

        .btn-secondary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.2);
        }

        .result-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .result-section.hidden {
            display: none;
        }

        .result-section h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 22px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .equation-card {
            background: var(--code-bg);
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 25px;
            text-align: center;
        }

        .equation-display {
            font-family: 'Courier New', monospace;
            font-size: 32px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .coefficient {
            color: var(--accent-color);
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .reactant, .product {
            padding: 5px 15px;
            background: var(--card-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .arrow {
            color: var(--primary-color);
            font-size: 24px;
            margin: 0 20px;
        }

        .validation-card {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            margin-bottom: 25px;
            color: white;
        }

        .validation-card.invalid {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }

        .validation-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .validation-text {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .validation-details {
            font-size: 16px;
            opacity: 0.9;
        }

        .result-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .result-item {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        .result-item .label {
            font-size: 14px;
            color: var(--muted-color);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-item .value {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-color);
        }

        .balance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .balance-table thead {
            background: var(--table-header-bg);
        }

        .balance-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-color);
            border-bottom: 2px solid var(--border-color);
        }

        .balance-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .balance-table tr:hover {
            background: var(--table-hover-bg);
        }

        .element-count {
            display: inline-block;
            padding: 2px 8px;
            background: var(--secondary-color);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }

        .explanation-box {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 25px;
            border-left: 4px solid var(--accent-color);
            margin-top: 25px;
        }

        .explanation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 18px;
        }

        .explanation-content {
            color: var(--text-color);
            line-height: 1.7;
        }

        .step-box {
            background: var(--code-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            border-left: 3px solid var(--secondary-color);
        }

        .step-number {
            display: inline-block;
            background: var(--secondary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }

        .error-section {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
        }

        .error-section.hidden {
            display: none;
        }

        .error-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #e74c3c;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .error-section p {
            color: #e74c3c;
            margin: 0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="plugin-container">
        <header class="plugin-header">
            <div class="plugin-header-content">
                <a href="#" class="back-button">
                    <i class="fas fa-arrow-left"></i> Назад
                </a>
                <div class="plugin-title-section">
                    <div class="header-logo">⚖️</div>
                    <h1><i class="fas fa-balance-scale"></i> Балансировщик химических уравнений</h1>
                </div>
                <button id="themeToggle" class="theme-toggle"><i class="fas fa-moon"></i></button>
            </div>
        </header>

        <main class="principle-container">
            <div class="info-section">
                <h2>Балансировка химических уравнений</h2>
                <p>Введите уравнение реакции для автоматической балансировки. Используйте знак "=" для разделения реагентов и продуктов.</p>
                <p>Примеры правильного ввода:</p>
                <code>H2 + O2 = H2O</code> <code>Fe + O2 = Fe2O3</code> <code>CH4 + O2 = CO2 + H2O</code>
            </div>

            <form id="balanceForm" class="form">
                <div class="form-group">
                    <label>Химическое уравнение:</label>
                    <input type="text" id="equationInput" class="form-control equation-input"
                           placeholder="H2 + O2 = H2O" required>
                    <small>Разделяйте вещества знаком "+", реагенты и продукты знаком "="</small>

                    <div class="examples-grid">
                        <div class="example-tag" data-equation="H2 + O2 = H2O">H₂ + O₂ → H₂O</div>
                        <div class="example-tag" data-equation="Fe + O2 = Fe2O3">Fe + O₂ → Fe₂O₃</div>
                        <div class="example-tag" data-equation="CH4 + O2 = CO2 + H2O">CH₄ + O₂ → CO₂ + H₂O</div>
                        <div class="example-tag" data-equation="NaOH + HCl = NaCl + H2O">NaOH + HCl → NaCl + H₂O</div>
                        <div class="example-tag" data-equation="Al + HCl = AlCl3 + H2">Al + HCl → AlCl₃ + H₂</div>
                        <div class="example-tag" data-equation="CaCO3 = CaO + CO2">CaCO₃ → CaO + CO₂</div>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-balance-scale"></i> Сбалансировать уравнение
                    </button>
                    <button type="button" class="btn-secondary" onclick="clearEquation()">
                        <i class="fas fa-broom"></i> Очистить
                    </button>
                </div>
            </form>

            <div id="result" class="result-section hidden">
                <h3>Результат балансировки</h3>

                <div class="equation-card">
                    <div id="balancedEquation" class="equation-display">
                        <span class="coefficient">2</span><span class="reactant">H₂</span> +
                        <span class="coefficient">1</span><span class="reactant">O₂</span>
                        <span class="arrow">→</span>
                        <span class="coefficient">2</span><span class="product">H₂O</span>
                    </div>
                </div>

                <div id="validationCard" class="validation-card">
                    <div class="validation-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="validation-text">Уравнение сбалансировано</div>
                    <div class="validation-details">Количество атомов каждого элемента одинаково слева и справа</div>
                </div>

                <div class="result-header">
                    <div class="result-item">
                        <div class="label">Коэффициенты:</div>
                        <div class="value" id="coefficientsCount">3</div>
                    </div>

                    <div class="result-item">
                        <div class="label">Различных элементов:</div>
                        <div class="value" id="elementsCount">2</div>
                    </div>

                    <div class="result-item">
                        <div class="label">Тип реакции:</div>
                        <div class="value" id="reactionType">Соединения</div>
                    </div>
                </div>

                <div class="formula-card">
                    <div class="formula-title">Баланс атомов:</div>
                    <table class="balance-table">
                        <thead>
                            <tr>
                                <th>Элемент</th>
                                <th>В реагентах</th>
                                <th>В продуктах</th>
                                <th>Статус</th>
                            </tr>
                        </thead>
                        <tbody id="balanceTable">
                            <!-- Заполнится через JS -->
                        </tbody>
                    </table>
                </div>

                <div class="explanation-box">
                    <div class="explanation-header"><i class="fas fa-lightbulb"></i> Как было сбалансировано</div>
                    <div class="explanation-content">
                        <div id="stepExplanation">
                            <!-- Шаги балансировки -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="error" class="error-section hidden">
                <h3><i class="fas fa-exclamation-circle"></i> Ошибка</h3>
                <p id="errorMessage"></p>
            </div>

            <div class="info-section" style="margin-top: 40px;">
                <h2>Правила балансировки уравнений</h2>
                <div class="rules-list">
                    <div class="step-box">
                        <span class="step-number">1</span>
                        <strong>Закон сохранения массы:</strong> Число атомов каждого элемента должно быть одинаковым слева и справа.
                    </div>
                    <div class="step-box">
                        <span class="step-number">2</span>
                        <strong>Изменяем только коэффициенты:</strong> Нельзя менять индексы в формулах веществ, только коэффициенты перед ними.
                    </div>
                    <div class="step-box">
                        <span class="step-number">3</span>
                        <strong>Начинаем с сложных веществ:</strong> Сначала балансируем элементы, которые встречаются в одном веществе.
                    </div>
                    <div class="step-box">
                        <span class="step-number">4</span>
                        <strong>В последнюю очередь водород и кислород:</strong> Чаще всего их балансируют в конце.
                    </div>
                    <div class="step-box">
                        <span class="step-number">5</span>
                        <strong>Проверяем все атомы:</strong> После балансировки проверяем все элементы еще раз.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            initTheme();
            initExamples();
            document.getElementById("balanceForm").addEventListener("submit", balanceEquation);
        });

        function initTheme() {
            const btn = document.getElementById("themeToggle");
            const saved = localStorage.getItem("theme") || "light";
            document.documentElement.setAttribute("data-theme", saved);

            btn.innerHTML = saved === "light" ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';

            btn.addEventListener("click", () => {
                const current = document.documentElement.getAttribute("data-theme");
                const next = current === "light" ? "dark" : "light";
                document.documentElement.setAttribute("data-theme", next);
                localStorage.setItem("theme", next);
                btn.innerHTML = next === "light" ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            });
        }

        function initExamples() {
            document.querySelectorAll('.example-tag').forEach(tag => {
                tag.addEventListener('click', () => {
                    const equation = tag.getAttribute('data-equation');
                    document.getElementById('equationInput').value = equation;

                    // Подсветка активного тега
                    document.querySelectorAll('.example-tag').forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');

                    balanceEquation({preventDefault: () => {}});
                });
            });
        }

        function clearEquation() {
            document.getElementById('equationInput').value = '';
            document.getElementById('result').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.querySelectorAll('.example-tag').forEach(t => t.classList.remove('active'));
        }

        // Парсинг химической формулы
        function parseMolecule(molecule) {
            const elements = {};
            let i = 0;
            const n = molecule.length;

            while (i < n) {
                // Парсим элемент
                let element = '';
                if (i < n && /[A-Z]/.test(molecule[i])) {
                    element += molecule[i++];
                    if (i < n && /[a-z]/.test(molecule[i])) {
                        element += molecule[i++];
                    }

                    // Парсим количество
                    let count = '';
                    while (i < n && /\d/.test(molecule[i])) {
                        count += molecule[i++];
                    }

                    const elementCount = count === '' ? 1 : parseInt(count);
                    elements[element] = (elements[element] || 0) + elementCount;
                }
                // Скобки
                else if (molecule[i] === '(') {
                    const start = i + 1;
                    let depth = 1;
                    i++;

                    while (i < n && depth > 0) {
                        if (molecule[i] === '(') depth++;
                        else if (molecule[i] === ')') depth--;
                        i++;
                    }

                    const inside = molecule.substring(start, i - 1);
                    const subElements = parseMolecule(inside);

                    // Множитель после скобок
                    let multiplier = '';
                    while (i < n && /\d/.test(molecule[i])) {
                        multiplier += molecule[i++];
                    }

                    const mult = multiplier === '' ? 1 : parseInt(multiplier);

                    // Умножаем
                    for (const [el, count] of Object.entries(subElements)) {
                        elements[el] = (elements[el] || 0) + count * mult;
                    }
                } else {
                    i++;
                }
            }

            return elements;
        }

        // Парсинг всего уравнения
        function parseEquation(equation) {
            // Заменяем -> или → на =
            equation = equation.replace(/->|→/g, '=');

            const sides = equation.split('=');
            if (sides.length !== 2) {
                throw new Error('Уравнение должно содержать одну стрелку (реагенты = продукты)');
            }

            const reactants = sides[0].split('+').map(s => s.trim());
            const products = sides[1].split('+').map(s => s.trim());

            // Удаляем пустые строки
            const cleanReactants = reactants.filter(r => r.length > 0);
            const cleanProducts = products.filter(p => p.length > 0);

            if (cleanReactants.length === 0 || cleanProducts.length === 0) {
                throw new Error('Уравнение должно содержать хотя бы один реагент и один продукт');
            }

            return {
                reactants: cleanReactants,
                products: cleanProducts,
                original: equation
            };
        }

        // Балансировка уравнения (метод алгебраических коэффициентов)
        function balanceChemicalEquation(equation) {
            const parsed = parseEquation(equation);
            const allMolecules = [...parsed.reactants, ...parsed.products];
            const allElements = new Set();

            // Собираем все элементы
            allMolecules.forEach(molecule => {
                const elements = parseMolecule(molecule);
                Object.keys(elements).forEach(el => allElements.add(el));
            });

            const elements = Array.from(allElements);
            const molecules = allMolecules.length;

            // Матрица для метода Гаусса
            const matrix = [];
            for (let i = 0; i < elements.length; i++) {
                matrix[i] = [];
                for (let j = 0; j < molecules; j++) {
                    matrix[i][j] = 0;
                }
            }

            // Заполняем матрицу
            for (let i = 0; i < elements.length; i++) {
                const element = elements[i];

                for (let j = 0; j < molecules; j++) {
                    const molecule = allMolecules[j];
                    const moleculeElements = parseMolecule(molecule);
                    matrix[i][j] = moleculeElements[element] || 0;

                    // Для продуктов меняем знак
                    if (j >= parsed.reactants.length) {
                        matrix[i][j] = -matrix[i][j];
                    }
                }
            }

            // Добавляем уравнение для коэффициентов (сумма = 1)
            matrix.push([]);
            for (let j = 0; j < molecules; j++) {
                matrix[elements.length][j] = 1;
            }

            // Правая часть уравнения
            const b = [];
            for (let i = 0; i < elements.length; i++) {
                b[i] = 0;
            }
            b[elements.length] = 1;

            // Решаем систему линейных уравнений (упрощенный метод)
            // Для простых уравнений используем эвристический подход

            return balanceSimple(parsed.reactants, parsed.products, elements);
        }

        // Эвристический метод балансировки для простых уравнений
        function balanceSimple(reactants, products, elements) {
            // Начинаем с коэффициентов 1
            const coeffs = {};
            reactants.forEach(r => coeffs[r] = 1);
            products.forEach(p => coeffs[p] = 1);

            const steps = [];

            // Для каждого элемента балансируем
            for (const element of elements) {
                let leftCount = 0;
                let rightCount = 0;

                // Считаем атомы слева
                reactants.forEach(r => {
                    const mol = parseMolecule(r);
                    leftCount += (mol[element] || 0) * coeffs[r];
                });

                // Считаем атомы справа
                products.forEach(p => {
                    const mol = parseMolecule(p);
                    rightCount += (mol[element] || 0) * coeffs[p];
                });

                // Если не сбалансировано, корректируем
                if (leftCount !== rightCount) {
                    // Находим вещества, содержащие этот элемент
                    const leftMolecules = reactants.filter(r => {
                        const mol = parseMolecule(r);
                        return mol[element] > 0;
                    });

                    const rightMolecules = products.filter(p => {
                        const mol = parseMolecule(p);
                        return mol[element] > 0;
                    });

                    // Простая балансировка
                    if (leftMolecules.length === 1 && rightMolecules.length === 1) {
                        const leftMol = leftMolecules[0];
                        const rightMol = rightMolecules[0];
                        const leftHas = parseMolecule(leftMol)[element];
                        const rightHas = parseMolecule(rightMol)[element];

                        // Наименьшее общее кратное
                        const lcm = leftHas * rightHas / gcd(leftHas, rightHas);
                        const leftCoeff = lcm / leftHas;
                        const rightCoeff = lcm / rightHas;

                        // Обновляем коэффициенты
                        coeffs[leftMol] = leftCoeff;
                        coeffs[rightMol] = rightCoeff;

                        steps.push(`Балансируем ${element}: устанавливаем коэффициент ${leftCoeff} перед ${leftMol} и ${rightCoeff} перед ${rightMol}`);
                    }
                }
            }

            // Упрощаем коэффициенты (делим на НОД)
            const allCoeffs = Object.values(coeffs);
            const commonDivisor = allCoeffs.reduce(gcd);

            if (commonDivisor > 1) {
                Object.keys(coeffs).forEach(key => {
                    coeffs[key] /= commonDivisor;
                });
                steps.push(`Упрощаем коэффициенты, деля на ${commonDivisor}`);
            }

            return {
                coefficients: coeffs,
                steps: steps,
                reactants: reactants,
                products: products
            };
        }

        // НОД двух чисел
        function gcd(a, b) {
            a = Math.abs(Math.round(a));
            b = Math.abs(Math.round(b));

            while (b) {
                const temp = b;
                b = a % b;
                a = temp;
            }
            return a;
        }

        // Проверка баланса
        function checkBalance(reactants, products, coefficients) {
            const allElements = new Set();
            const elementCounts = {};

            // Собираем все элементы слева
            reactants.forEach(r => {
                const mol = parseMolecule(r);
                Object.keys(mol).forEach(el => {
                    allElements.add(el);
                    elementCounts[el] = elementCounts[el] || { left: 0, right: 0 };
                    elementCounts[el].left += mol[el] * coefficients[r];
                });
            });

            // Собираем все элементы справа
            products.forEach(p => {
                const mol = parseMolecule(p);
                Object.keys(mol).forEach(el => {
                    allElements.add(el);
                    elementCounts[el] = elementCounts[el] || { left: 0, right: 0 };
                    elementCounts[el].right += mol[el] * coefficients[p];
                });
            });

            // Проверяем баланс
            let isBalanced = true;
            const balanceDetails = [];

            for (const element of allElements) {
                const left = elementCounts[element]?.left || 0;
                const right = elementCounts[element]?.right || 0;
                const balanced = Math.abs(left - right) < 0.0001;

                balanceDetails.push({
                    element: element,
                    left: left,
                    right: right,
                    balanced: balanced
                });

                if (!balanced) isBalanced = false;
            }

            return {
                isBalanced: isBalanced,
                details: balanceDetails,
                elements: Array.from(allElements)
            };
        }

        // Форматирование уравнения
        function formatEquation(reactants, products, coefficients) {
            const leftSide = reactants.map(r => {
                const coeff = coefficients[r];
                return (coeff === 1 ? '' : coeff) + formatFormula(r);
            }).join(' + ');

            const rightSide = products.map(p => {
                const coeff = coefficients[p];
                return (coeff === 1 ? '' : coeff) + formatFormula(p);
            }).join(' + ');

            return `${leftSide} → ${rightSide}`;
        }

        function formatFormula(formula) {
            return formula.replace(/(\d+)/g, (match) => {
                const subscripts = {"0": "₀", "1": "₁", "2": "₂", "3": "₃", "4": "₄",
                                   "5": "₅", "6": "₆", "7": "₇", "8": "₈", "9": "₉"};
                return match.split('').map(digit => subscripts[digit]).join('');
            });
        }

        // Определение типа реакции
        function determineReactionType(reactants, products) {
            const rCount = reactants.length;
            const pCount = products.length;

            if (rCount === 2 && pCount === 1) return 'Соединения';
            if (rCount === 1 && pCount === 2) return 'Разложения';
            if (rCount === 1 && pCount === 1) {
                // Проверяем на изомеризацию
                const rElems = Object.keys(parseMolecule(reactants[0]));
                const pElems = Object.keys(parseMolecule(products[0]));
                if (JSON.stringify(rElems.sort()) === JSON.stringify(pElems.sort())) {
                    return 'Изомеризации';
                }
                return 'Замещения/обмена';
            }
            if (rCount >= 2 && pCount >= 2) {
                // Проверяем на обмен
                const hasAcidBase = reactants.some(r => r.includes('OH') || r.includes('H')) &&
                                   products.some(p => p.includes('H2O'));
                if (hasAcidBase) return 'Нейтрализации';
                return 'Обмена';
            }

            return 'Неизвестный тип';
        }

        function balanceEquation(e) {
            e.preventDefault();

            const equation = document.getElementById("equationInput").value.trim();
            if (!equation) return;

            try {
                // Балансируем уравнение
                const result = balanceChemicalEquation(equation);
                const balanceCheck = checkBalance(result.reactants, result.products, result.coefficients);

                // Отображаем результаты
                showResults(equation, result, balanceCheck);

            } catch (error) {
                showError(error.message);
            }
        }

        function showResults(originalEquation, result, balanceCheck) {
            document.getElementById("error").classList.add("hidden");
            document.getElementById("result").classList.remove("hidden");

            // Форматируем и отображаем уравнение
            const formattedEq = formatEquation(result.reactants, result.products, result.coefficients);

            const equationDisplay = document.getElementById("balancedEquation");
            equationDisplay.innerHTML = '';

            // Реагенты
            result.reactants.forEach((r, i) => {
                const coeff = result.coefficients[r];
                if (i > 0) equationDisplay.innerHTML += ' + ';

                const coeffSpan = document.createElement('span');
                coeffSpan.className = 'coefficient';
                coeffSpan.textContent = coeff === 1 ? '' : coeff;

                const reactantSpan = document.createElement('span');
                reactantSpan.className = 'reactant';
                reactantSpan.textContent = formatFormula(r);

                equationDisplay.appendChild(coeffSpan);
                equationDisplay.appendChild(reactantSpan);
            });

            // Стрелка
            const arrowSpan = document.createElement('span');
            arrowSpan.className = 'arrow';
            arrowSpan.textContent = '→';
            equationDisplay.appendChild(arrowSpan);

            // Продукты
            result.products.forEach((p, i) => {
                const coeff = result.coefficients[p];
                if (i > 0) equationDisplay.innerHTML += ' + ';

                const coeffSpan = document.createElement('span');
                coeffSpan.className = 'coefficient';
                coeffSpan.textContent = coeff === 1 ? '' : coeff;

                const productSpan = document.createElement('span');
                productSpan.className = 'product';
                productSpan.textContent = formatFormula(p);

                equationDisplay.appendChild(coeffSpan);
                equationDisplay.appendChild(productSpan);
            });

            // Карточка валидации
            const validationCard = document.getElementById("validationCard");
            if (balanceCheck.isBalanced) {
                validationCard.className = 'validation-card';
                validationCard.innerHTML = `
                    <div class="validation-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="validation-text">Уравнение сбалансировано</div>
                    <div class="validation-details">Количество атомов каждого элемента одинаково слева и справа</div>
                `;
            } else {
                validationCard.className = 'validation-card invalid';
                validationCard.innerHTML = `
                    <div class="validation-icon"><i class="fas fa-times-circle"></i></div>
                    <div class="validation-text">Уравнение не сбалансировано</div>
                    <div class="validation-details">Требуется ручная балансировка</div>
                `;
            }

            // Статистика
            const coefficients = Object.values(result.coefficients);
            document.getElementById("coefficientsCount").textContent = coefficients.filter(c => c > 1).length;
            document.getElementById("elementsCount").textContent = balanceCheck.elements.length;
            document.getElementById("reactionType").textContent = determineReactionType(result.reactants, result.products);

            // Таблица баланса
            const tableBody = document.getElementById("balanceTable");
            tableBody.innerHTML = '';

            balanceCheck.details.forEach(item => {
                const row = document.createElement("tr");

                const statusIcon = item.balanced ?
                    '<i class="fas fa-check" style="color: #27ae60;"></i>' :
                    '<i class="fas fa-times" style="color: #e74c3c;"></i>';

                row.innerHTML = `
                    <td><strong>${item.element}</strong></td>
                    <td>${item.left.toFixed(0)}</td>
                    <td>${item.right.toFixed(0)}</td>
                    <td>${statusIcon}</td>
                `;
                tableBody.appendChild(row);
            });

            // Объяснение шагов
            const stepExplanation = document.getElementById("stepExplanation");
            stepExplanation.innerHTML = '';

            if (result.steps.length > 0) {
                result.steps.forEach((step, index) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step-box';
                    stepDiv.innerHTML = `
                        <span class="step-number">${index + 1}</span>
                        ${step}
                    `;
                    stepExplanation.appendChild(stepDiv);
                });
            } else {
                stepExplanation.innerHTML = '<p>Уравнение уже было сбалансировано.</p>';
            }
        }

        function showError(message) {
            document.getElementById("result").classList.add("hidden");
            document.getElementById("error").classList.remove("hidden");
            document.getElementById("errorMessage").textContent = message;
        }
    </script>
</body>
</html>