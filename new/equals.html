{% extends "base.html" %}

{% block title %}–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏–æ–Ω–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π - {{ config.site_title }}{% endblock %}

{% block content %}
<div class="plugin-container">
    <header class="plugin-header">
        <div class="plugin-header-content">
            <a href="/" class="back-button">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
            </a>
            <div class="plugin-title-section">
                <img src="{{ config.site_logo_dark }}" class="header-logo plugin-logo" alt="logo">
                <h1><i class="fas fa-calculator"></i> –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –ò–û–ù–ù–´–• –£–†–ê–í–ù–ï–ù–ò–ô</h1>
            </div>
            <button id="themeToggle" class="theme-toggle"><i class="fas fa-moon"></i></button>
        </div>
    </header>

    <main class="main-content">
        <div class="principle-container">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="info-section">
                <h2>üî• –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –†–ï–®–ê–¢–ï–õ–¨ –ò–û–ù–ù–´–• –£–†–ê–í–ù–ï–ù–ò–ô</h2>
                <p>–í–≤–æ–¥–∏ –õ–Æ–ë–û–ï —É—Ä–∞–≤–Ω–µ–Ω–∏–µ - –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–∞–º –≤—Å—ë —É—Ä–∞–≤–Ω—è–µ—Ç, –æ–ø—Ä–µ–¥–µ–ª–∏—Ç —Ç–∏–ø —Ä–µ–∞–∫—Ü–∏–∏, —Ä–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç—å –∏ –¥–∞—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–æ–Ω–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è.</p>
                <p><strong>–§–æ—Ä–º–∞—Ç:</strong> <code>Fe + 2HCl ‚Üí FeCl2 + H2</code> –∏–ª–∏ <code>AgNO3 + NaCl = AgCl + NaNO3</code></p>
            </div>

            <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
            <form id="ionEquationForm" class="form">
                <div class="form-group">
                    <label><i class="fas fa-pencil-alt"></i> –í–≤–µ–¥–∏—Ç–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ:</label>
                    <input id="equationInput" class="form-control"
                           placeholder="–ü—Ä–∏–º–µ—Ä: Fe + 2HCl ‚Üí FeCl2 + H2"
                           value="Fe + 2HCl ‚Üí FeCl2 + H2"
                           required>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-calculator"></i> –†–∞—Å—Å—á–∏—Ç–∞—Ç—å
                    </button>
                    <button type="button" id="clearBtn" class="btn-secondary">
                        <i class="fas fa-broom"></i> –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                    <button type="button" id="randomExample" class="btn-info">
                        <i class="fas fa-random"></i> –°–ª—É—á–∞–π–Ω—ã–π –ø—Ä–∏–º–µ—Ä
                    </button>
                </div>
            </form>

            <!-- –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–º–µ—Ä—ã -->
            <div class="examples-section">
                <h3><i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–º–µ—Ä—ã:</h3>
                <div class="examples-grid">
                    <button class="example-btn" data-eq="Fe + 2HCl ‚Üí FeCl2 + H2">
                        Fe + 2HCl ‚Üí FeCl‚ÇÇ + H‚ÇÇ
                    </button>
                    <button class="example-btn" data-eq="HCl + NaOH ‚Üí NaCl + H2O">
                        HCl + NaOH ‚Üí NaCl + H‚ÇÇO
                    </button>
                    <button class="example-btn" data-eq="AgNO3 + NaCl ‚Üí AgCl + NaNO3">
                        AgNO‚ÇÉ + NaCl ‚Üí AgCl + NaNO‚ÇÉ
                    </button>
                    <button class="example-btn" data-eq="BaCl2 + Na2SO4 ‚Üí BaSO4 + 2NaCl">
                        BaCl‚ÇÇ + Na‚ÇÇSO‚ÇÑ ‚Üí BaSO‚ÇÑ + 2NaCl
                    </button>
                    <button class="example-btn" data-eq="Na2CO3 + 2HCl ‚Üí 2NaCl + H2O + CO2">
                        Na‚ÇÇCO‚ÇÉ + 2HCl ‚Üí 2NaCl + H‚ÇÇO + CO‚ÇÇ
                    </button>
                    <button class="example-btn" data-eq="CuSO4 + Zn ‚Üí ZnSO4 + Cu">
                        CuSO‚ÇÑ + Zn ‚Üí ZnSO‚ÇÑ + Cu
                    </button>
                </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
            <div id="resultsSection" class="result-section hidden">
                <h3><i class="fas fa-chart-line"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>

                <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ -->
                <div class="result-card">
                    <div class="result-header">
                        <i class="fas fa-check-circle"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–∫—Ü–∏–∏
                    </div>
                    <div class="result-content">
                        <p id="feasibilityText"></p>
                        <p id="reactionType"></p>
                    </div>
                </div>

                <!-- –£—Ä–∞–≤–Ω–µ–Ω–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ -->
                <div class="result-card">
                    <div class="result-header">
                        <i class="fas fa-balance-scale"></i> –£—Ä–∞–≤–Ω–µ–Ω–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
                    </div>
                    <div class="result-content">
                        <div id="balancedEquation" class="equation-display"></div>
                    </div>
                </div>

                <!-- –†–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç—å -->
                <div class="result-card">
                    <div class="result-header">
                        <i class="fas fa-flask"></i> –†–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç—å –≤–µ—â–µ—Å—Ç–≤
                    </div>
                    <div class="result-content">
                        <div id="solubilityInfo" class="solubility-grid"></div>
                    </div>
                </div>

                <!-- –ò–æ–Ω–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è -->
                <div class="result-card">
                    <div class="result-header">
                        <i class="fas fa-atom"></i> –ò–æ–Ω–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
                    </div>
                    <div class="result-content">
                        <div class="equation-step">
                            <h4>–ü–æ–ª–Ω–æ–µ –∏–æ–Ω–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ:</h4>
                            <div id="fullIonicEquation" class="equation-display ion-equation"></div>
                        </div>
                        <div class="equation-step">
                            <h4>–°–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–µ –∏–æ–Ω–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ:</h4>
                            <div id="netIonicEquation" class="equation-display ion-equation"></div>
                        </div>
                        <div class="equation-step">
                            <h4>–ò–æ–Ω—ã-–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏:</h4>
                            <div id="spectatorIons"></div>
                        </div>
                    </div>
                </div>

                <!-- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ -->
                <div class="result-card">
                    <div class="result-header">
                        <i class="fas fa-info-circle"></i> –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–∏
                    </div>
                    <div class="result-content">
                        <div id="reactionExplanation"></div>
                    </div>
                </div>
            </div>

            <!-- –û—à–∏–±–∫–∞ -->
            <div id="errorSection" class="error-section hidden">
                <h3><i class="fas fa-exclamation-circle"></i> –û—à–∏–±–∫–∞</h3>
                <p id="errorMessage"></p>
            </div>
        </div>
    </main>
</div>

<style>
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
.principle-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è */
.info-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

.info-section h2 {
    margin-top: 0;
    color: var(--primary-color);
    font-size: 1.5rem;
}

.info-section p {
    color: var(--text-secondary);
    line-height: 1.6;
    margin: 10px 0;
}

/* –§–æ—Ä–º–∞ */
.form {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid var(--border-color);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: var(--text-color);
    font-size: 1.1rem;
}

.form-control {
    width: 100%;
    padding: 14px 16px;
    font-size: 1.1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-color);
    color: var(--text-color);
    font-family: 'Courier New', monospace;
    transition: all 0.3s;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
}

/* –ö–Ω–æ–ø–∫–∏ */
.button-group {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.btn-primary, .btn-secondary, .btn-info {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
    font-weight: 500;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}

.btn-secondary {
    background: var(--border-color);
    color: var(--text-color);
}

.btn-secondary:hover {
    background: var(--border-dark);
}

.btn-info {
    background: #3498db;
    color: white;
}

.btn-info:hover {
    background: #2980b9;
}

/* –ü—Ä–∏–º–µ—Ä—ã */
.examples-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid var(--border-color);
}

.examples-section h3 {
    margin-top: 0;
    color: var(--primary-color);
    font-size: 1.3rem;
    margin-bottom: 15px;
}

.examples-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 10px;
}

.example-btn {
    padding: 12px 16px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    text-align: left;
    font-family: 'Courier New', monospace;
    font-size: 0.95rem;
    color: var(--text-color);
    transition: all 0.3s;
}

.example-btn:hover {
    border-color: var(--primary-color);
    background: rgba(var(--primary-rgb), 0.1);
}

/* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã */
.result-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 0;
    margin-bottom: 25px;
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.result-section h3 {
    padding: 20px 25px;
    margin: 0;
    background: var(--header-bg);
    border-bottom: 1px solid var(--border-color);
    color: var(--primary-color);
}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
.result-card {
    border-bottom: 1px solid var(--border-color);
    padding: 20px 25px;
}

.result-card:last-child {
    border-bottom: none;
}

.result-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    color: var(--primary-color);
    font-weight: 600;
    font-size: 1.1rem;
}

.result-content {
    color: var(--text-color);
    line-height: 1.6;
}

/* –£—Ä–∞–≤–Ω–µ–Ω–∏—è */
.equation-display {
    font-family: 'Courier New', monospace;
    font-size: 1.3rem;
    padding: 15px;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    margin: 10px 0;
    overflow-x: auto;
    white-space: nowrap;
}

.ion-equation {
    color: #9b59b6;
    border-left: 4px solid #9b59b6;
}

.equation-step {
    margin-bottom: 20px;
}

.equation-step h4 {
    margin-bottom: 10px;
    color: var(--text-color);
    font-size: 1rem;
}

/* –†–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç—å */
.solubility-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 10px;
}

.solubility-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--bg-color);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.solubility-symbol {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: bold;
    min-width: 40px;
    text-align: center;
}

.sol-r { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
.sol-m { background: rgba(241, 196, 15, 0.2); color: #f1c40f; }
.sol-n { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
.sol-g { background: rgba(52, 152, 219, 0.2); color: #3498db; }
.sol-w { background: rgba(155, 89, 182, 0.2); color: #9b59b6; }
.sol-t { background: rgba(149, 165, 166, 0.2); color: #95a5a6; }

/* –ò–æ–Ω—ã-–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ */
#spectatorIons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.spectator-tag {
    display: inline-block;
    padding: 6px 12px;
    background: rgba(149, 165, 166, 0.2);
    border-radius: 6px;
    font-size: 0.9rem;
    color: var(--text-color);
    border: 1px solid rgba(149, 165, 166, 0.3);
}

/* –û—à–∏–±–∫–∞ */
.error-section {
    background: rgba(231, 76, 60, 0.1);
    border: 1px solid rgba(231, 76, 60, 0.3);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
}

.error-section h3 {
    margin-top: 0;
    color: #e74c3c;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.error-section p {
    color: var(--text-color);
    line-height: 1.6;
}

/* –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
.hidden {
    display: none !important;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.result-section, .error-section {
    animation: fadeIn 0.3s ease-out;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .principle-container {
        padding: 15px;
    }

    .examples-grid {
        grid-template-columns: 1fr;
    }

    .button-group {
        flex-direction: column;
    }

    .btn-primary, .btn-secondary, .btn-info {
        width: 100%;
        justify-content: center;
    }

    .equation-display {
        font-size: 1.1rem;
        padding: 12px;
    }

    .solubility-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// =======================================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// =======================================================

document.addEventListener("DOMContentLoaded", () => {
    initTheme();
    initEventListeners();

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –ø—Ä–∏–º–µ—Ä–∞
    setTimeout(() => {
        document.getElementById("ionEquationForm").dispatchEvent(new Event('submit', {cancelable: true}));
    }, 300);
});

function initTheme() {
    const btn = document.getElementById("themeToggle");
    const saved = localStorage.getItem("theme") || "light";
    document.documentElement.setAttribute("data-theme", saved);

    btn.addEventListener("click", () => {
        const current = document.documentElement.getAttribute("data-theme");
        const next = current === "light" ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
    });
}

function initEventListeners() {
    const form = document.getElementById("ionEquationForm");
    const clearBtn = document.getElementById("clearBtn");
    const randomBtn = document.getElementById("randomExample");

    form.addEventListener("submit", calculateIonEquation);
    clearBtn.addEventListener("click", clearForm);
    randomBtn.addEventListener("click", loadRandomExample);

    // –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–º–µ—Ä—ã
    document.querySelectorAll(".example-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const eq = this.getAttribute("data-eq");
            document.getElementById("equationInput").value = eq;
            calculateIonEquation(new Event('submit', {cancelable: true}));
        });
    });

    // Enter –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
    document.getElementById("equationInput").addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            calculateIonEquation(new Event('submit', {cancelable: true}));
        }
    });
}

// =======================================================
// –£–õ–£–ß–®–ï–ù–ù–´–ô –ì–ï–ù–ï–†–ê–¢–û–† –ò–û–ù–ù–´–• –£–†–ê–í–ù–ï–ù–ò–ô
// =======================================================

const solubilityMap = {
    '—Ä': {symbol: '—Ä', name: '–†–∞—Å—Ç–≤–æ—Ä–∏–º', class: 'sol-r'},
    '–º': {symbol: '–º', name: '–ú–∞–ª–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º', class: 'sol-m'},
    '–Ω': {symbol: '–Ω', name: '–ù–µ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º', class: 'sol-n'},
    '–≥': {symbol: '–≥', name: '–ì–∞–∑', class: 'sol-g'},
    '–≤': {symbol: '–≤', name: '–í–æ–¥–∞', class: 'sol-w'},
    '—Ç': {symbol: '—Ç', name: '–¢–≤—ë—Ä–¥–æ–µ', class: 'sol-t'},
    '?': {symbol: '?', name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', class: 'sol-t'}
};

const stateMap = {
    'aq': '–≤–æ–¥–Ω. —Ä-—Ä',
    's': '—Ç–≤.',
    'l': '–∂–∏–¥–∫.',
    'g': '–≥–∞–∑'
};

const compoundsDB = {
    // –ö–∏—Å–ª–æ—Ç—ã
    'HCl': {name: '—Å–æ–ª—è–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞', type: 'acid', ions: ['H‚Å∫', 'Cl‚Åª'], sol: '—Ä', state: 'aq'},
    'H2SO4': {name: '—Å–µ—Ä–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞', type: 'acid', ions: ['2H‚Å∫', 'SO‚ÇÑ¬≤‚Åª'], sol: '—Ä', state: 'aq'},
    'HNO3': {name: '–∞–∑–æ—Ç–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞', type: 'acid', ions: ['H‚Å∫', 'NO‚ÇÉ‚Åª'], sol: '—Ä', state: 'aq'},
    'H3PO4': {name: '—Ñ–æ—Å—Ñ–æ—Ä–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞', type: 'acid', ions: ['3H‚Å∫', 'PO‚ÇÑ¬≥‚Åª'], sol: '—Ä', state: 'aq'},
    'H2CO3': {name: '—É–≥–æ–ª—å–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞', type: 'acid', ions: ['2H‚Å∫', 'CO‚ÇÉ¬≤‚Åª'], sol: '—Ä', state: 'aq'},

    // –û—Å–Ω–æ–≤–∞–Ω–∏—è
    'NaOH': {name: '–≥–∏–¥—Ä–æ–∫—Å–∏–¥ –Ω–∞—Ç—Ä–∏—è', type: 'base', ions: ['Na‚Å∫', 'OH‚Åª'], sol: '—Ä', state: 'aq'},
    'KOH': {name: '–≥–∏–¥—Ä–æ–∫—Å–∏–¥ –∫–∞–ª–∏—è', type: 'base', ions: ['K‚Å∫', 'OH‚Åª'], sol: '—Ä', state: 'aq'},
    'Ba(OH)2': {name: '–≥–∏–¥—Ä–æ–∫—Å–∏–¥ –±–∞—Ä–∏—è', type: 'base', ions: ['Ba¬≤‚Å∫', '2OH‚Åª'], sol: '—Ä', state: 'aq'},
    'Ca(OH)2': {name: '–≥–∏–¥—Ä–æ–∫—Å–∏–¥ –∫–∞–ª—å—Ü–∏—è', type: 'base', ions: ['Ca¬≤‚Å∫', '2OH‚Åª'], sol: '–º', state: 'aq'},
    'NH4OH': {name: '–≥–∏–¥—Ä–æ–∫—Å–∏–¥ –∞–º–º–æ–Ω–∏—è', type: 'base', ions: ['NH‚ÇÑ‚Å∫', 'OH‚Åª'], sol: '—Ä', state: 'aq'},

    // –°–æ–ª–∏ —Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–µ
    'NaCl': {name: '—Ö–ª–æ—Ä–∏–¥ –Ω–∞—Ç—Ä–∏—è', type: 'salt', ions: ['Na‚Å∫', 'Cl‚Åª'], sol: '—Ä', state: 'aq'},
    'KCl': {name: '—Ö–ª–æ—Ä–∏–¥ –∫–∞–ª–∏—è', type: 'salt', ions: ['K‚Å∫', 'Cl‚Åª'], sol: '—Ä', state: 'aq'},
    'AgNO3': {name: '–Ω–∏—Ç—Ä–∞—Ç —Å–µ—Ä–µ–±—Ä–∞', type: 'salt', ions: ['Ag‚Å∫', 'NO‚ÇÉ‚Åª'], sol: '—Ä', state: 'aq'},
    'NaNO3': {name: '–Ω–∏—Ç—Ä–∞—Ç –Ω–∞—Ç—Ä–∏—è', type: 'salt', ions: ['Na‚Å∫', 'NO‚ÇÉ‚Åª'], sol: '—Ä', state: 'aq'},
    'Na2SO4': {name: '—Å—É–ª—å—Ñ–∞—Ç –Ω–∞—Ç—Ä–∏—è', type: 'salt', ions: ['2Na‚Å∫', 'SO‚ÇÑ¬≤‚Åª'], sol: '—Ä', state: 'aq'},
    'K2SO4': {name: '—Å—É–ª—å—Ñ–∞—Ç –∫–∞–ª–∏—è', type: 'salt', ions: ['2K‚Å∫', 'SO‚ÇÑ¬≤‚Åª'], sol: '—Ä', state: 'aq'},
    'CaCl2': {name: '—Ö–ª–æ—Ä–∏–¥ –∫–∞–ª—å—Ü–∏—è', type: 'salt', ions: ['Ca¬≤‚Å∫', '2Cl‚Åª'], sol: '—Ä', state: 'aq'},
    'BaCl2': {name: '—Ö–ª–æ—Ä–∏–¥ –±–∞—Ä–∏—è', type: 'salt', ions: ['Ba¬≤‚Å∫', '2Cl‚Åª'], sol: '—Ä', state: 'aq'},
    'MgCl2': {name: '—Ö–ª–æ—Ä–∏–¥ –º–∞–≥–Ω–∏—è', type: 'salt', ions: ['Mg¬≤‚Å∫', '2Cl‚Åª'], sol: '—Ä', state: 'aq'},
    'FeCl2': {name: '—Ö–ª–æ—Ä–∏–¥ –∂–µ–ª–µ–∑–∞(II)', type: 'salt', ions: ['Fe¬≤‚Å∫', '2Cl‚Åª'], sol: '—Ä', state: 'aq'},
    'FeCl3': {name: '—Ö–ª–æ—Ä–∏–¥ –∂–µ–ª–µ–∑–∞(III)', type: 'salt', ions: ['Fe¬≥‚Å∫', '3Cl‚Åª'], sol: '—Ä', state: 'aq'},
    'CuCl2': {name: '—Ö–ª–æ—Ä–∏–¥ –º–µ–¥–∏(II)', type: 'salt', ions: ['Cu¬≤‚Å∫', '2Cl‚Åª'], sol: '—Ä', state: 'aq'},
    'ZnCl2': {name: '—Ö–ª–æ—Ä–∏–¥ —Ü–∏–Ω–∫–∞', type: 'salt', ions: ['Zn¬≤‚Å∫', '2Cl‚Åª'], sol: '—Ä', state: 'aq'},
    'AlCl3': {name: '—Ö–ª–æ—Ä–∏–¥ –∞–ª—é–º–∏–Ω–∏—è', type: 'salt', ions: ['Al¬≥‚Å∫', '3Cl‚Åª'], sol: '—Ä', state: 'aq'},

    // –î—Ä—É–≥–∏–µ —Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–µ —Å–æ–ª–∏
    'CuSO4': {name: '—Å—É–ª—å—Ñ–∞—Ç –º–µ–¥–∏(II)', type: 'salt', ions: ['Cu¬≤‚Å∫', 'SO‚ÇÑ¬≤‚Åª'], sol: '—Ä', state: 'aq'},
    'ZnSO4': {name: '—Å—É–ª—å—Ñ–∞—Ç —Ü–∏–Ω–∫–∞', type: 'salt', ions: ['Zn¬≤‚Å∫', 'SO‚ÇÑ¬≤‚Åª'], sol: '—Ä', state: 'aq'},
    'FeSO4': {name: '—Å—É–ª—å—Ñ–∞—Ç –∂–µ–ª–µ–∑–∞(II)', type: 'salt', ions: ['Fe¬≤‚Å∫', 'SO‚ÇÑ¬≤‚Åª'], sol: '—Ä', state: 'aq'},
    'Al2(SO4)3': {name: '—Å—É–ª—å—Ñ–∞—Ç –∞–ª—é–º–∏–Ω–∏—è', type: 'salt', ions: ['2Al¬≥‚Å∫', '3SO‚ÇÑ¬≤‚Åª'], sol: '—Ä', state: 'aq'},

    // –°–æ–ª–∏ –Ω–µ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–µ (–æ—Å–∞–¥–∫–∏)
    'AgCl': {name: '—Ö–ª–æ—Ä–∏–¥ —Å–µ—Ä–µ–±—Ä–∞', type: 'salt', formula: 'AgCl', sol: '–Ω', state: 's'},
    'BaSO4': {name: '—Å—É–ª—å—Ñ–∞—Ç –±–∞—Ä–∏—è', type: 'salt', formula: 'BaSO‚ÇÑ', sol: '–Ω', state: 's'},
    'CaCO3': {name: '–∫–∞—Ä–±–æ–Ω–∞—Ç –∫–∞–ª—å—Ü–∏—è', type: 'salt', formula: 'CaCO‚ÇÉ', sol: '–Ω', state: 's'},
    'Ag2CO3': {name: '–∫–∞—Ä–±–æ–Ω–∞—Ç —Å–µ—Ä–µ–±—Ä–∞', type: 'salt', formula: 'Ag‚ÇÇCO‚ÇÉ', sol: '–Ω', state: 's'},

    // –ì–∏–¥—Ä–æ–∫—Å–∏–¥—ã –Ω–µ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–µ
    'Fe(OH)3': {name: '–≥–∏–¥—Ä–æ–∫—Å–∏–¥ –∂–µ–ª–µ–∑–∞(III)', type: 'base', formula: 'Fe(OH)‚ÇÉ', sol: '–Ω', state: 's'},
    'Cu(OH)2': {name: '–≥–∏–¥—Ä–æ–∫—Å–∏–¥ –º–µ–¥–∏(II)', type: 'base', formula: 'Cu(OH)‚ÇÇ', sol: '–Ω', state: 's'},
    'Al(OH)3': {name: '–≥–∏–¥—Ä–æ–∫—Å–∏–¥ –∞–ª—é–º–∏–Ω–∏—è', type: 'base', formula: 'Al(OH)‚ÇÉ', sol: '–Ω', state: 's'},
    'Mg(OH)2': {name: '–≥–∏–¥—Ä–æ–∫—Å–∏–¥ –º–∞–≥–Ω–∏—è', type: 'base', formula: 'Mg(OH)‚ÇÇ', sol: '–Ω', state: 's'},

    // –ì–∞–∑—ã –∏ –≤–æ–¥–∞
    'H2O': {name: '–≤–æ–¥–∞', type: 'water', formula: 'H‚ÇÇO', sol: '–≤', state: 'l'},
    'CO2': {name: '–æ–∫—Å–∏–¥ —É–≥–ª–µ—Ä–æ–¥–∞(IV)', type: 'gas', formula: 'CO‚ÇÇ', sol: '–≥', state: 'g'},
    'SO2': {name: '–æ–∫—Å–∏–¥ —Å–µ—Ä—ã(IV)', type: 'gas', formula: 'SO‚ÇÇ', sol: '–≥', state: 'g'},
    'H2': {name: '–≤–æ–¥–æ—Ä–æ–¥', type: 'gas', formula: 'H‚ÇÇ', sol: '–≥', state: 'g'},
    'NH3': {name: '–∞–º–º–∏–∞–∫', type: 'gas', formula: 'NH‚ÇÉ', sol: '–≥', state: 'g'},
    'O2': {name: '–∫–∏—Å–ª–æ—Ä–æ–¥', type: 'gas', formula: 'O‚ÇÇ', sol: '–≥', state: 'g'},

    // –ú–µ—Ç–∞–ª–ª—ã
    'Fe': {name: '–∂–µ–ª–µ–∑–æ', type: 'metal', formula: 'Fe', sol: '—Ç', state: 's'},
    'Cu': {name: '–º–µ–¥—å', type: 'metal', formula: 'Cu', sol: '—Ç', state: 's'},
    'Zn': {name: '—Ü–∏–Ω–∫', type: 'metal', formula: 'Zn', sol: '—Ç', state: 's'},
    'Al': {name: '–∞–ª—é–º–∏–Ω–∏–π', type: 'metal', formula: 'Al', sol: '—Ç', state: 's'},
    'Mg': {name: '–º–∞–≥–Ω–∏–π', type: 'metal', formula: 'Mg', sol: '—Ç', state: 's'},
    'Ag': {name: '—Å–µ—Ä–µ–±—Ä–æ', type: 'metal', formula: 'Ag', sol: '—Ç', state: 's'},

    // –û–∫—Å–∏–¥—ã
    'CaO': {name: '–æ–∫—Å–∏–¥ –∫–∞–ª—å—Ü–∏—è', type: 'oxide', formula: 'CaO', sol: '—Ä', state: 'aq'},
    'CuO': {name: '–æ–∫—Å–∏–¥ –º–µ–¥–∏(II)', type: 'oxide', formula: 'CuO', sol: '–Ω', state: 's'},
    'Fe2O3': {name: '–æ–∫—Å–∏–¥ –∂–µ–ª–µ–∑–∞(III)', type: 'oxide', formula: 'Fe‚ÇÇO‚ÇÉ', sol: '–Ω', state: 's'},
    'Al2O3': {name: '–æ–∫—Å–∏–¥ –∞–ª—é–º–∏–Ω–∏—è', type: 'oxide', formula: 'Al‚ÇÇO‚ÇÉ', sol: '–Ω', state: 's'},

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
    'Na2CO3': {name: '–∫–∞—Ä–±–æ–Ω–∞—Ç –Ω–∞—Ç—Ä–∏—è', type: 'salt', ions: ['2Na‚Å∫', 'CO‚ÇÉ¬≤‚Åª'], sol: '—Ä', state: 'aq'},
    'K2CO3': {name: '–∫–∞—Ä–±–æ–Ω–∞—Ç –∫–∞–ª–∏—è', type: 'salt', ions: ['2K‚Å∫', 'CO‚ÇÉ¬≤‚Åª'], sol: '—Ä', state: 'aq'},
    'NaHCO3': {name: '–≥–∏–¥—Ä–æ–∫–∞—Ä–±–æ–Ω–∞—Ç –Ω–∞—Ç—Ä–∏—è', type: 'salt', ions: ['Na‚Å∫', 'HCO‚ÇÉ‚Åª'], sol: '—Ä', state: 'aq'},
    'Na2SO3': {name: '—Å—É–ª—å—Ñ–∏—Ç –Ω–∞—Ç—Ä–∏—è', type: 'salt', ions: ['2Na‚Å∫', 'SO‚ÇÉ¬≤‚Åª'], sol: '—Ä', state: 'aq'},
    'Na2S': {name: '—Å—É–ª—å—Ñ–∏–¥ –Ω–∞—Ç—Ä–∏—è', type: 'salt', ions: ['2Na‚Å∫', 'S¬≤‚Åª'], sol: '—Ä', state: 'aq'}
};

async function calculateIonEquation(e) {
    e.preventDefault();

    const input = document.getElementById("equationInput").value.trim();
    if (!input) return showError("–í–≤–µ–¥–∏—Ç–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ");

    try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        const btn = document.querySelector("#ionEquationForm button[type='submit']");
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é...';
        btn.disabled = true;

        // –î–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(async () => {
            try {
                // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç (–≥–ª–∞–≤–Ω–∞—è —Ñ–∏—à–∫–∞ - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–æ–Ω–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è)
                const result = calculateWithProperIonicEquations(input);

                if (result.error) {
                    showError(result.error);
                } else {
                    displayResults(result);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞:", error);
                showError("–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: " + error.message);
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }, 100);

    } catch (error) {
        console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error);
        showError("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: " + error.message);
    }
}

function calculateWithProperIonicEquations(equation) {
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
    const eq = equation.replace(/=/g, '‚Üí').replace(/\s+/g, ' ').trim();
    const [left, right] = eq.split('‚Üí').map(s => s.trim());

    if (!left || !right) {
        return { error: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —É—Ä–∞–≤–Ω–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ‚Üí –∏–ª–∏ =" };
    }

    // –ü–∞—Ä—Å–∏–º
    const reactants = parseSide(left);
    const products = parseSide(right);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–µ–∞–∫—Ü–∏–∏
    const type = determineReactionType(reactants, products);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å
    const feasible = checkFeasibility(reactants, products);

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–æ–Ω–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
    const ionic = generateProperIonicEquations(reactants, products);

    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç—å
    const solubility = getSolubilityInfo([...reactants, ...products]);

    // –û–±—ä—è—Å–Ω–µ–Ω–∏–µ
    const explanation = generateExplanation(type, feasible, reactants, products, ionic);

    return {
        balancedEquation: eq,
        feasible: feasible,
        reactionType: type,
        solubility: solubility,
        fullIonicEquation: ionic.full,
        netIonicEquation: ionic.net,
        spectatorIons: ionic.spectators,
        explanation: explanation
    };
}

function parseSide(side) {
    return side.split('+')
        .map(s => s.trim())
        .filter(s => s)
        .map(parseFormula);
}

function parseFormula(formula) {
    // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
    let coeff = 1;
    let f = formula;

    // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤ –Ω–∞—á–∞–ª–µ
    const coeffMatch = formula.match(/^(\d+)(?=[A-Z(])/);
    if (coeffMatch) {
        coeff = parseInt(coeffMatch[1]);
        f = formula.slice(coeffMatch[1].length);
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    const compound = compoundsDB[f] || {
        name: f,
        type: 'unknown',
        sol: '?',
        state: f.includes('OH') ? 's' : 'aq',
        ions: guessIonsFromFormula(f)
    };

    return {
        formula: f,
        coefficient: coeff,
        ...compound
    };
}

function guessIonsFromFormula(formula) {
    // –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–æ–Ω–æ–≤
    if (formula === 'H2O') return null;
    if (formula === 'CO2' || formula === 'SO2' || formula === 'H2') return null;

    // –î–ª—è –∫–∏—Å–ª–æ—Ç
    if (formula.startsWith('H')) {
        if (formula.includes('SO4')) return ['2H‚Å∫', 'SO‚ÇÑ¬≤‚Åª'];
        if (formula.includes('NO3')) return ['H‚Å∫', 'NO‚ÇÉ‚Åª'];
        if (formula.includes('Cl')) return ['H‚Å∫', 'Cl‚Åª'];
        if (formula.includes('CO3')) return ['2H‚Å∫', 'CO‚ÇÉ¬≤‚Åª'];
        return ['H‚Å∫', 'X‚Åª']; // –û–±—â–∏–π —Å–ª—É—á–∞–π
    }

    // –î–ª—è –æ—Å–Ω–æ–≤–∞–Ω–∏–π
    if (formula.endsWith('OH')) {
        const metal = formula.replace('OH', '');
        if (metal === 'Na') return ['Na‚Å∫', 'OH‚Åª'];
        if (metal === 'K') return ['K‚Å∫', 'OH‚Åª'];
        if (metal === 'Ca' || metal === 'Ba') return [metal + '¬≤‚Å∫', '2OH‚Åª'];
        return [metal + '‚Å∫', 'OH‚Åª'];
    }

    // –î–ª—è —Å–æ–ª–µ–π
    if (formula.includes('Cl')) {
        if (formula === 'NaCl') return ['Na‚Å∫', 'Cl‚Åª'];
        if (formula === 'KCl') return ['K‚Å∫', 'Cl‚Åª'];
        if (formula === 'CaCl2') return ['Ca¬≤‚Å∫', '2Cl‚Åª'];
        if (formula === 'BaCl2') return ['Ba¬≤‚Å∫', '2Cl‚Åª'];
        if (formula === 'FeCl2') return ['Fe¬≤‚Å∫', '2Cl‚Åª'];
        if (formula === 'FeCl3') return ['Fe¬≥‚Å∫', '3Cl‚Åª'];
    }

    if (formula.includes('SO4')) {
        if (formula === 'Na2SO4') return ['2Na‚Å∫', 'SO‚ÇÑ¬≤‚Åª'];
        if (formula === 'K2SO4') return ['2K‚Å∫', 'SO‚ÇÑ¬≤‚Åª'];
        if (formula === 'CuSO4') return ['Cu¬≤‚Å∫', 'SO‚ÇÑ¬≤‚Åª'];
    }

    return null; // –ù–µ –∑–Ω–∞–µ–º –∏–æ–Ω—ã
}

function determineReactionType(reactants, products) {
    const hasAcid = reactants.some(r => r.type === 'acid');
    const hasBase = reactants.some(r => r.type === 'base');
    const hasMetal = reactants.some(r => r.type === 'metal');
    const hasGasProduct = products.some(p => p.sol === '–≥');
    const hasPrecipitate = products.some(p => p.sol === '–Ω');
    const hasWater = products.some(p => p.formula === 'H2O');

    if (hasAcid && hasBase && hasWater) return '–ù–µ–π—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏';
    if (hasMetal && hasAcid) return '–ó–∞–º–µ—â–µ–Ω–∏—è (–º–µ—Ç–∞–ª–ª + –∫–∏—Å–ª–æ—Ç–∞)';
    if (reactants.some(r => r.type === 'metal') && reactants.some(r => r.type === 'salt')) {
        return '–ó–∞–º–µ—â–µ–Ω–∏—è (–º–µ—Ç–∞–ª–ª + —Å–æ–ª—å)';
    }
    if (hasPrecipitate) return '–û–±–º–µ–Ω–∞ —Å –æ—Å–∞–¥–∫–æ–º';
    if (hasGasProduct) return '–° –≥–∞–∑–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º';

    return '–û–±–º–µ–Ω–∞';
}

function checkFeasibility(reactants, products) {
    const hasGas = products.some(p => p.sol === '–≥');
    const hasPrecipitate = products.some(p => p.sol === '–Ω');
    const hasWater = products.some(p => p.formula === 'H2O');
    const hasWeakElectrolyte = products.some(p =>
        (p.type === 'acid' && !p.strong) ||
        (p.type === 'base' && !p.strong)
    );

    if (hasGas || hasPrecipitate || hasWater || hasWeakElectrolyte) {
        return {
            possible: true,
            reason: '–ï—Å—Ç—å –¥–≤–∏–∂—É—â–∞—è —Å–∏–ª–∞ —Ä–µ–∞–∫—Ü–∏–∏',
            drivingForce: getDrivingForce(products)
        };
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –û–í–† (–º–µ—Ç–∞–ª–ª + –∫–∏—Å–ª–æ—Ç–∞, –º–µ—Ç–∞–ª–ª + —Å–æ–ª—å)
    const hasRedox = reactants.some(r => r.type === 'metal') &&
                    (reactants.some(r => r.type === 'acid') ||
                     reactants.some(r => r.type === 'salt'));

    if (hasRedox) {
        return {
            possible: true,
            reason: '–û–∫–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è',
            drivingForce: '–û–í–† (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–µ–ø–µ–Ω–µ–π –æ–∫–∏—Å–ª–µ–Ω–∏—è)'
        };
    }

    return {
        possible: false,
        reason: '–ù–µ—Ç –¥–≤–∏–∂—É—â–µ–π —Å–∏–ª—ã —Ä–µ–∞–∫—Ü–∏–∏',
        drivingForce: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'
    };
}

function getDrivingForce(products) {
    if (products.some(p => p.sol === '–≥')) return '–í—ã–¥–µ–ª–µ–Ω–∏–µ –≥–∞–∑–∞';
    if (products.some(p => p.sol === '–Ω')) return '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –æ—Å–∞–¥–∫–∞';
    if (products.some(p => p.formula === 'H2O')) return '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–ª–∞–±–æ–≥–æ —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–∞ (–≤–æ–¥—ã)';
    return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
}

// =======================================================
// –ì–õ–ê–í–ù–ê–Ø –§–ò–®–ö–ê: –ü–†–ê–í–ò–õ–¨–ù–´–ï –ò–û–ù–ù–´–ï –£–†–ê–í–ù–ï–ù–ò–Ø
// =======================================================

function generateProperIonicEquations(reactants, products) {
    const equationKey = reactants.map(r => r.formula).join('+') + '‚Üí' +
                       products.map(p => p.formula).join('+');

    // –ë–∞–∑–∞ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –ü–†–ê–í–ò–õ–¨–ù–´–• –∏–æ–Ω–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π
    const predefinedIonicEquations = {
        // –ú–µ—Ç–∞–ª–ª—ã —Å –∫–∏—Å–ª–æ—Ç–∞–º–∏
        'Fe+2HCl‚ÜíFeCl2+H2': {
            full: 'Fe(s) + 2H‚Å∫(aq) + 2Cl‚Åª(aq) ‚Üí Fe¬≤‚Å∫(aq) + 2Cl‚Åª(aq) + H‚ÇÇ(g)',
            net: 'Fe(s) + 2H‚Å∫(aq) ‚Üí Fe¬≤‚Å∫(aq) + H‚ÇÇ(g)',
            spectators: ['Cl‚Åª']
        },
        'Zn+2HCl‚ÜíZnCl2+H2': {
            full: 'Zn(s) + 2H‚Å∫(aq) + 2Cl‚Åª(aq) ‚Üí Zn¬≤‚Å∫(aq) + 2Cl‚Åª(aq) + H‚ÇÇ(g)',
            net: 'Zn(s) + 2H‚Å∫(aq) ‚Üí Zn¬≤‚Å∫(aq) + H‚ÇÇ(g)',
            spectators: ['Cl‚Åª']
        },
        '2Al+6HCl‚Üí2AlCl3+3H2': {
            full: '2Al(s) + 6H‚Å∫(aq) + 6Cl‚Åª(aq) ‚Üí 2Al¬≥‚Å∫(aq) + 6Cl‚Åª(aq) + 3H‚ÇÇ(g)',
            net: '2Al(s) + 6H‚Å∫(aq) ‚Üí 2Al¬≥‚Å∫(aq) + 3H‚ÇÇ(g)',
            spectators: ['Cl‚Åª']
        },
        'Mg+2HCl‚ÜíMgCl2+H2': {
            full: 'Mg(s) + 2H‚Å∫(aq) + 2Cl‚Åª(aq) ‚Üí Mg¬≤‚Å∫(aq) + 2Cl‚Åª(aq) + H‚ÇÇ(g)',
            net: 'Mg(s) + 2H‚Å∫(aq) ‚Üí Mg¬≤‚Å∫(aq) + H‚ÇÇ(g)',
            spectators: ['Cl‚Åª']
        },

        // –ù–µ–π—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è
        'HCl+NaOH‚ÜíNaCl+H2O': {
            full: 'H‚Å∫(aq) + Cl‚Åª(aq) + Na‚Å∫(aq) + OH‚Åª(aq) ‚Üí Na‚Å∫(aq) + Cl‚Åª(aq) + H‚ÇÇO(l)',
            net: 'H‚Å∫(aq) + OH‚Åª(aq) ‚Üí H‚ÇÇO(l)',
            spectators: ['Na‚Å∫', 'Cl‚Åª']
        },
        'H2SO4+2NaOH‚ÜíNa2SO4+2H2O': {
            full: '2H‚Å∫(aq) + SO‚ÇÑ¬≤‚Åª(aq) + 2Na‚Å∫(aq) + 2OH‚Åª(aq) ‚Üí 2Na‚Å∫(aq) + SO‚ÇÑ¬≤‚Åª(aq) + 2H‚ÇÇO(l)',
            net: 'H‚Å∫(aq) + OH‚Åª(aq) ‚Üí H‚ÇÇO(l)',
            spectators: ['Na‚Å∫', 'SO‚ÇÑ¬≤‚Åª']
        },
        'HNO3+NaOH‚ÜíNaNO3+H2O': {
            full: 'H‚Å∫(aq) + NO‚ÇÉ‚Åª(aq) + Na‚Å∫(aq) + OH‚Åª(aq) ‚Üí Na‚Å∫(aq) + NO‚ÇÉ‚Åª(aq) + H‚ÇÇO(l)',
            net: 'H‚Å∫(aq) + OH‚Åª(aq) ‚Üí H‚ÇÇO(l)',
            spectators: ['Na‚Å∫', 'NO‚ÇÉ‚Åª']
        },

        // –û—Å–∞–¥–∫–∏
        'AgNO3+NaCl‚ÜíAgCl+NaNO3': {
            full: 'Ag‚Å∫(aq) + NO‚ÇÉ‚Åª(aq) + Na‚Å∫(aq) + Cl‚Åª(aq) ‚Üí AgCl(s) + Na‚Å∫(aq) + NO‚ÇÉ‚Åª(aq)',
            net: 'Ag‚Å∫(aq) + Cl‚Åª(aq) ‚Üí AgCl(s)',
            spectators: ['Na‚Å∫', 'NO‚ÇÉ‚Åª']
        },
        'BaCl2+Na2SO4‚ÜíBaSO4+2NaCl': {
            full: 'Ba¬≤‚Å∫(aq) + 2Cl‚Åª(aq) + 2Na‚Å∫(aq) + SO‚ÇÑ¬≤‚Åª(aq) ‚Üí BaSO‚ÇÑ(s) + 2Na‚Å∫(aq) + 2Cl‚Åª(aq)',
            net: 'Ba¬≤‚Å∫(aq) + SO‚ÇÑ¬≤‚Åª(aq) ‚Üí BaSO‚ÇÑ(s)',
            spectators: ['Na‚Å∫', 'Cl‚Åª']
        },
        'Pb(NO3)2+2KI‚ÜíPbI2+2KNO3': {
            full: 'Pb¬≤‚Å∫(aq) + 2NO‚ÇÉ‚Åª(aq) + 2K‚Å∫(aq) + 2I‚Åª(aq) ‚Üí PbI‚ÇÇ(s) + 2K‚Å∫(aq) + 2NO‚ÇÉ‚Åª(aq)',
            net: 'Pb¬≤‚Å∫(aq) + 2I‚Åª(aq) ‚Üí PbI‚ÇÇ(s)',
            spectators: ['K‚Å∫', 'NO‚ÇÉ‚Åª']
        },

        // –ì–∞–∑–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
        'Na2CO3+2HCl‚Üí2NaCl+H2O+CO2': {
            full: '2Na‚Å∫(aq) + CO‚ÇÉ¬≤‚Åª(aq) + 2H‚Å∫(aq) + 2Cl‚Åª(aq) ‚Üí 2Na‚Å∫(aq) + 2Cl‚Åª(aq) + H‚ÇÇO(l) + CO‚ÇÇ(g)',
            net: 'CO‚ÇÉ¬≤‚Åª(aq) + 2H‚Å∫(aq) ‚Üí H‚ÇÇO(l) + CO‚ÇÇ(g)',
            spectators: ['Na‚Å∫', 'Cl‚Åª']
        },
        'CaCO3+2HCl‚ÜíCaCl2+CO2+H2O': {
            full: 'CaCO‚ÇÉ(s) + 2H‚Å∫(aq) + 2Cl‚Åª(aq) ‚Üí Ca¬≤‚Å∫(aq) + 2Cl‚Åª(aq) + CO‚ÇÇ(g) + H‚ÇÇO(l)',
            net: 'CaCO‚ÇÉ(s) + 2H‚Å∫(aq) ‚Üí Ca¬≤‚Å∫(aq) + CO‚ÇÇ(g) + H‚ÇÇO(l)',
            spectators: ['Cl‚Åª']
        },
        'Na2SO3+2HCl‚Üí2NaCl+H2O+SO2': {
            full: '2Na‚Å∫(aq) + SO‚ÇÉ¬≤‚Åª(aq) + 2H‚Å∫(aq) + 2Cl‚Åª(aq) ‚Üí 2Na‚Å∫(aq) + 2Cl‚Åª(aq) + H‚ÇÇO(l) + SO‚ÇÇ(g)',
            net: 'SO‚ÇÉ¬≤‚Åª(aq) + 2H‚Å∫(aq) ‚Üí H‚ÇÇO(l) + SO‚ÇÇ(g)',
            spectators: ['Na‚Å∫', 'Cl‚Åª']
        },

        // –ó–∞–º–µ—â–µ–Ω–∏–µ –º–µ—Ç–∞–ª–ª–æ–≤
        'CuSO4+Zn‚ÜíZnSO4+Cu': {
            full: 'Cu¬≤‚Å∫(aq) + SO‚ÇÑ¬≤‚Åª(aq) + Zn(s) ‚Üí Zn¬≤‚Å∫(aq) + SO‚ÇÑ¬≤‚Åª(aq) + Cu(s)',
            net: 'Cu¬≤‚Å∫(aq) + Zn(s) ‚Üí Zn¬≤‚Å∫(aq) + Cu(s)',
            spectators: ['SO‚ÇÑ¬≤‚Åª']
        },
        'Fe+CuSO4‚ÜíFeSO4+Cu': {
            full: 'Fe(s) + Cu¬≤‚Å∫(aq) + SO‚ÇÑ¬≤‚Åª(aq) ‚Üí Fe¬≤‚Å∫(aq) + SO‚ÇÑ¬≤‚Åª(aq) + Cu(s)',
            net: 'Fe(s) + Cu¬≤‚Å∫(aq) ‚Üí Fe¬≤‚Å∫(aq) + Cu(s)',
            spectators: ['SO‚ÇÑ¬≤‚Åª']
        },
        'Zn+CuCl2‚ÜíZnCl2+Cu': {
            full: 'Zn(s) + Cu¬≤‚Å∫(aq) + 2Cl‚Åª(aq) ‚Üí Zn¬≤‚Å∫(aq) + 2Cl‚Åª(aq) + Cu(s)',
            net: 'Zn(s) + Cu¬≤‚Å∫(aq) ‚Üí Zn¬≤‚Å∫(aq) + Cu(s)',
            spectators: ['Cl‚Åª']
        },

        // –° –æ–∫—Å–∏–¥–∞–º–∏
        'CuO+2HCl‚ÜíCuCl2+H2O': {
            full: 'CuO(s) + 2H‚Å∫(aq) + 2Cl‚Åª(aq) ‚Üí Cu¬≤‚Å∫(aq) + 2Cl‚Åª(aq) + H‚ÇÇO(l)',
            net: 'CuO(s) + 2H‚Å∫(aq) ‚Üí Cu¬≤‚Å∫(aq) + H‚ÇÇO(l)',
            spectators: ['Cl‚Åª']
        },
        'Fe2O3+6HCl‚Üí2FeCl3+3H2O': {
            full: 'Fe‚ÇÇO‚ÇÉ(s) + 6H‚Å∫(aq) + 6Cl‚Åª(aq) ‚Üí 2Fe¬≥‚Å∫(aq) + 6Cl‚Åª(aq) + 3H‚ÇÇO(l)',
            net: 'Fe‚ÇÇO‚ÇÉ(s) + 6H‚Å∫(aq) ‚Üí 2Fe¬≥‚Å∫(aq) + 3H‚ÇÇO(l)',
            spectators: ['Cl‚Åª']
        },

        // –° –≥–∏–¥—Ä–æ–∫—Å–∏–¥–∞–º–∏
        'Cu(OH)2+2HCl‚ÜíCuCl2+2H2O': {
            full: 'Cu(OH)‚ÇÇ(s) + 2H‚Å∫(aq) + 2Cl‚Åª(aq) ‚Üí Cu¬≤‚Å∫(aq) + 2Cl‚Åª(aq) + 2H‚ÇÇO(l)',
            net: 'Cu(OH)‚ÇÇ(s) + 2H‚Å∫(aq) ‚Üí Cu¬≤‚Å∫(aq) + 2H‚ÇÇO(l)',
            spectators: ['Cl‚Åª']
        },
        'Al(OH)3+3HCl‚ÜíAlCl3+3H2O': {
            full: 'Al(OH)‚ÇÉ(s) + 3H‚Å∫(aq) + 3Cl‚Åª(aq) ‚Üí Al¬≥‚Å∫(aq) + 3Cl‚Åª(aq) + 3H‚ÇÇO(l)',
            net: 'Al(OH)‚ÇÉ(s) + 3H‚Å∫(aq) ‚Üí Al¬≥‚Å∫(aq) + 3H‚ÇÇO(l)',
            spectators: ['Cl‚Åª']
        }
    };

    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    if (predefinedIonicEquations[equationKey]) {
        return predefinedIonicEquations[equationKey];
    }

    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏
    for (const [key, value] of Object.entries(predefinedIonicEquations)) {
        const keyParts = key.split('‚Üí');
        const eqParts = equationKey.split('‚Üí');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞ –±–µ–∑ —É—á–µ—Ç–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
        const keyLeft = keyParts[0].split('+').map(s => s.replace(/^\d+/, '')).sort();
        const eqLeft = eqParts[0].split('+').map(s => s.replace(/^\d+/, '')).sort();

        const keyRight = keyParts[1].split('+').map(s => s.replace(/^\d+/, '')).sort();
        const eqRight = eqParts[1].split('+').map(s => s.replace(/^\d+/, '')).sort();

        if (JSON.stringify(keyLeft) === JSON.stringify(eqLeft) &&
            JSON.stringify(keyRight) === JSON.stringify(eqRight)) {
            return value;
        }
    }

    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    return generateGenericIonicEquations(reactants, products);
}

function generateGenericIonicEquations(reactants, products) {
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∏–æ–Ω—ã —Å –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω
    const leftIons = [];
    const rightIons = [];

    // –†–µ–∞–≥–µ–Ω—Ç—ã
    reactants.forEach(r => {
        const coeff = r.coefficient || 1;
        if (r.ions && (r.sol === '—Ä' || r.type === 'acid' || r.type === 'base')) {
            // –†–∞—Å—Ç–≤–æ—Ä–∏–º–æ–µ –∏–æ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            r.ions.forEach(ion => {
                // –£–º–Ω–æ–∂–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏–æ–Ω–∞ –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–µ—â–µ—Å—Ç–≤–∞
                const ionCoeff = getIonCoefficient(ion) * coeff;
                const ionWithoutCoeff = ion.replace(/^\d+/, '');
                leftIons.push({
                    ion: ionWithoutCoeff,
                    coeff: ionCoeff,
                    state: r.state === 's' ? 's' : 'aq'
                });
            });
        } else {
            // –ù–µ–∏–æ–Ω–Ω–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ (–º–µ—Ç–∞–ª–ª, –æ—Å–∞–¥–æ–∫, –≥–∞–∑, –≤–æ–¥–∞)
            leftIons.push({
                ion: r.formula,
                coeff: coeff,
                state: r.state || 's'
            });
        }
    });

    // –ü—Ä–æ–¥—É–∫—Ç—ã
    products.forEach(p => {
        const coeff = p.coefficient || 1;
        if (p.ions && (p.sol === '—Ä' || p.type === 'acid' || p.type === 'base')) {
            // –†–∞—Å—Ç–≤–æ—Ä–∏–º–æ–µ –∏–æ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            p.ions.forEach(ion => {
                const ionCoeff = getIonCoefficient(ion) * coeff;
                const ionWithoutCoeff = ion.replace(/^\d+/, '');
                rightIons.push({
                    ion: ionWithoutCoeff,
                    coeff: ionCoeff,
                    state: p.state === 's' ? 's' : 'aq'
                });
            });
        } else {
            // –ù–µ–∏–æ–Ω–Ω–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ
            rightIons.push({
                ion: p.formula,
                coeff: coeff,
                state: p.state || 's'
            });
        }
    });

    // –ù–∞—Ö–æ–¥–∏–º –∏–æ–Ω—ã-–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏
    const spectators = [];
    const netLeft = [];
    const netRight = [];

    // –ö–æ–ø–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã
    const leftCopy = [...leftIons];
    const rightCopy = [...rightIons];

    // –ù–∞—Ö–æ–¥–∏–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∏–æ–Ω—ã —Å –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω
    for (let i = leftCopy.length - 1; i >= 0; i--) {
        for (let j = rightCopy.length - 1; j >= 0; j--) {
            if (leftCopy[i].ion === rightCopy[j].ion &&
                leftCopy[i].state === 'aq' && rightCopy[j].state === 'aq') {
                // –≠—Ç–æ –∏–æ–Ω-–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å
                if (!spectators.includes(leftCopy[i].ion)) {
                    spectators.push(leftCopy[i].ion);
                }
                // –£–¥–∞–ª—è–µ–º –∏–∑ –∫–æ–ø–∏–π
                leftCopy.splice(i, 1);
                rightCopy.splice(j, 1);
                break;
            }
        }
    }

    // –û—Å—Ç–∞–≤—à–∏–µ—Å—è –∏–æ–Ω—ã - —Ä–µ–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Ä–µ–∞–∫—Ü–∏–∏
    netLeft.push(...leftCopy);
    netRight.push(...rightCopy);

    // –§–æ—Ä–º–∏—Ä—É–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏—è
    const formatSide = (ions) => {
        return ions.map(item => {
            const coeff = item.coeff > 1 ? item.coeff + '' : '';
            return `${coeff}${item.ion}(${item.state})`;
        }).join(' + ');
    };

    const full = formatSide(leftIons) + ' ‚Üí ' + formatSide(rightIons);
    const net = formatSide(netLeft) + ' ‚Üí ' + formatSide(netRight);

    return {
        full: full,
        net: net === full ? '–£—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–µ —Å–æ–∫—Ä–∞—â–∞–µ—Ç—Å—è' : net,
        spectators: spectators
    };
}

function getIonCoefficient(ion) {
    const match = ion.match(/^(\d+)/);
    return match ? parseInt(match[1]) : 1;
}

function getSolubilityInfo(compounds) {
    return compounds.map(c => ({
        formula: c.formula,
        name: c.name,
        solubility: c.sol,
        state: c.state
    }));
}

function generateExplanation(type, feasible, reactants, products, ionic) {
    let explanation = `<strong>–¢–∏–ø —Ä–µ–∞–∫—Ü–∏–∏:</strong> ${type}<br>`;

    if (feasible.possible) {
        explanation += `<strong>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å:</strong> ‚úÖ –†–µ–∞–∫—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞<br>`;
        explanation += `<strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${feasible.reason}<br>`;

        if (feasible.drivingForce) {
            explanation += `<strong>–î–≤–∏–∂—É—â–∞—è —Å–∏–ª–∞:</strong> ${feasible.drivingForce}<br>`;
        }
    } else {
        explanation += `<strong>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å:</strong> ‚ùå –†–µ–∞–∫—Ü–∏—è –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–∞<br>`;
        explanation += `<strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${feasible.reason}<br>`;
    }

    explanation += `<br><strong>–ê–Ω–∞–ª–∏–∑:</strong><br>`;

    // –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    const gases = products.filter(p => p.sol === '–≥');
    const precipitates = products.filter(p => p.sol === '–Ω');
    const water = products.filter(p => p.formula === 'H2O');

    if (gases.length > 0) {
        explanation += `‚Ä¢ –í—ã–¥–µ–ª—è–µ—Ç—Å—è –≥–∞–∑: ${gases.map(g => g.formula).join(', ')}<br>`;
    }

    if (precipitates.length > 0) {
        explanation += `‚Ä¢ –û–±—Ä–∞–∑—É–µ—Ç—Å—è –æ—Å–∞–¥–æ–∫: ${precipitates.map(p => p.formula).join(', ')}<br>`;
    }

    if (water.length > 0) {
        explanation += `‚Ä¢ –û–±—Ä–∞–∑—É–µ—Ç—Å—è –≤–æ–¥–∞ (—Å–ª–∞–±—ã–π —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç)<br>`;
    }

    if (ionic.spectators && ionic.spectators.length > 0) {
        explanation += `‚Ä¢ –ò–æ–Ω—ã-–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏: ${ionic.spectators.join(', ')}<br>`;
    }

    return explanation;
}

// =======================================================
// –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
// =======================================================

function displayResults(data) {
    // –°–∫—Ä—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
    document.getElementById("errorSection").classList.add("hidden");

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    const resultSection = document.getElementById("resultsSection");
    resultSection.classList.remove("hidden");

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    document.getElementById("feasibilityText").innerHTML =
        data.feasible.possible ?
        "‚úÖ <strong>–†–µ–∞–∫—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞</strong>" :
        "‚ùå <strong>–†–µ–∞–∫—Ü–∏—è –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–∞</strong>";

    if (data.feasible.reason) {
        document.getElementById("feasibilityText").innerHTML += `<br>${data.feasible.reason}`;
    }

    document.getElementById("reactionType").innerHTML =
        `<strong>–¢–∏–ø —Ä–µ–∞–∫—Ü–∏–∏:</strong> ${data.reactionType}`;

    document.getElementById("balancedEquation").innerHTML =
        formatEquation(data.balancedEquation);

    // –†–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç—å
    const solubilityDiv = document.getElementById("solubilityInfo");
    solubilityDiv.innerHTML = '';

    if (data.solubility && data.solubility.length > 0) {
        data.solubility.forEach(item => {
            const sol = solubilityMap[item.solubility] || solubilityMap['?'];
            const state = stateMap[item.state] || item.state;

            const div = document.createElement("div");
            div.className = "solubility-item";
            div.innerHTML = `
                <div>
                    <strong>${formatFormula(item.formula)}</strong>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        ${item.name || ''}
                    </div>
                </div>
                <div>
                    <span class="solubility-symbol ${sol.class}">${sol.symbol}</span>
                    <span style="margin-left: 8px; font-size: 0.9rem;">${sol.name}</span>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">${state}</div>
                </div>
            `;
            solubilityDiv.appendChild(div);
        });
    }

    // –ò–æ–Ω–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
    document.getElementById("fullIonicEquation").innerHTML =
        formatEquation(data.fullIonicEquation, true);

    document.getElementById("netIonicEquation").innerHTML =
        formatEquation(data.netIonicEquation, true);

    // –ò–æ–Ω—ã-–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏
    const spectatorsDiv = document.getElementById("spectatorIons");
    spectatorsDiv.innerHTML = '';

    if (data.spectatorIons && data.spectatorIons.length > 0) {
        data.spectatorIons.forEach(ion => {
            const span = document.createElement("span");
            span.className = "spectator-tag";
            span.textContent = ion;
            spectatorsDiv.appendChild(span);
        });
    } else {
        spectatorsDiv.textContent = "–ù–µ –Ω–∞–π–¥–µ–Ω—ã";
    }

    // –û–±—ä—è—Å–Ω–µ–Ω–∏–µ
    document.getElementById("reactionExplanation").innerHTML =
        data.explanation || '–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';

    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function formatEquation(equation, isIonic = false) {
    if (!equation) return '';

    return equation
        .replace(/(\d+)(?=[A-Z(])/g, '<span style="color: #e74c3c; font-weight: bold;">$1</span>')
        .replace(/‚Üí/g, ' ‚Üí ')
        .replace(/(H‚ÇÇO|CO‚ÇÇ|SO‚ÇÇ|NH‚ÇÉ|O‚ÇÇ|H‚ÇÇ)/g, match => {
            return `<span style="${isIonic ? 'color: #9b59b6;' : ''}">${match}</span>`;
        })
        .replace(/(H‚Å∫|Na‚Å∫|K‚Å∫|Ag‚Å∫|Ca¬≤‚Å∫|Ba¬≤‚Å∫|Mg¬≤‚Å∫|Zn¬≤‚Å∫|Cu¬≤‚Å∫|Fe¬≤‚Å∫|Fe¬≥‚Å∫|Al¬≥‚Å∫|Pb¬≤‚Å∫|NH‚ÇÑ‚Å∫|OH‚Åª|Cl‚Åª|Br‚Åª|I‚Åª|NO‚ÇÉ‚Åª|CH‚ÇÉCOO‚Åª|HCO‚ÇÉ‚Åª|SO‚ÇÑ¬≤‚Åª|CO‚ÇÉ¬≤‚Åª|SO‚ÇÉ¬≤‚Åª|S¬≤‚Åª|PO‚ÇÑ¬≥‚Åª)/g,
            '<span style="color: #9b59b6;">$1</span>')
        .replace(/\((aq|s|l|g)\)/g, '<span style="color: #7f8c8d; font-size: 0.9em;">($1)</span>')
        .replace(/‚ÇÇ/g, '‚ÇÇ')
        .replace(/‚ÇÉ/g, '‚ÇÉ')
        .replace(/‚ÇÑ/g, '‚ÇÑ');
}

function formatFormula(formula) {
    return formula
        .replace(/2/g, '‚ÇÇ')
        .replace(/3/g, '‚ÇÉ')
        .replace(/4/g, '‚ÇÑ');
}

// =======================================================
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
// =======================================================

function clearForm() {
    document.getElementById("equationInput").value = '';
    document.getElementById("resultsSection").classList.add("hidden");
    document.getElementById("errorSection").classList.add("hidden");
    document.getElementById("equationInput").focus();
}

function loadRandomExample() {
    const examples = [
        "Fe + 2HCl ‚Üí FeCl2 + H2",
        "Zn + 2HCl ‚Üí ZnCl2 + H2",
        "2Al + 6HCl ‚Üí 2AlCl3 + 3H2",
        "HCl + NaOH ‚Üí NaCl + H2O",
        "AgNO3 + NaCl ‚Üí AgCl + NaNO3",
        "BaCl2 + Na2SO4 ‚Üí BaSO4 + 2NaCl",
        "Na2CO3 + 2HCl ‚Üí 2NaCl + H2O + CO2",
        "CuSO4 + Zn ‚Üí ZnSO4 + Cu",
        "CuO + 2HCl ‚Üí CuCl2 + H2O",
        "Cu(OH)2 + 2HCl ‚Üí CuCl2 + 2H2O"
    ];

    const randomIndex = Math.floor(Math.random() * examples.length);
    document.getElementById("equationInput").value = examples[randomIndex];
    document.getElementById("equationInput").focus();
}

function showError(message) {
    document.getElementById("resultsSection").classList.add("hidden");

    const errorSection = document.getElementById("errorSection");
    errorSection.classList.remove("hidden");
    document.getElementById("errorMessage").textContent = message;

    errorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
</script>
{% endblock %}